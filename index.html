<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NTRIP CORS Station Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        :root {
            --primary-color: #3763f4;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
        }
        .dark {
            --tw-bg-opacity: 1;
            background-color: rgba(17, 24, 39, var(--tw-bg-opacity));
            --tw-text-opacity: 1;
            color: rgba(243, 244, 246, var(--tw-text-opacity));
        }
        .dark .card {
            --tw-bg-opacity: 1;
            background-color: rgba(31, 41, 55, var(--tw-bg-opacity));
            --tw-border-opacity: 1;
            border-color: rgba(55, 65, 81, var(--tw-border-opacity));
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .dark .spinner {
            border-color: rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary-color);
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-dot.online {
            background-color: var(--success-color);
        }
        .status-dot.offline {
            background-color: var(--danger-color);
        }
        .status-dot.unknown {
            background-color: var(--warning-color);
        }
        .uptime-bar {
            height: 6px;
            background-color: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 0.2rem;
        }
        .uptime-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s;
        }
        .uptime-high {
            background-color: var(--success-color);
        }
        .uptime-medium {
            background-color: var(--warning-color);
        }
        .uptime-low {
            background-color: var(--danger-color);
        }
        .modal-transition {
            transition: opacity 0.3s ease-out;
        }
        .dark .uptime-bar {
            background-color: #4b5563;
        }
        #map, #location-map {
            height: 500px;
            border-radius: 0.375rem;
        }
        #location-map {
            height: 300px;
        }
        .tab-active {
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color);
        }
        @media (max-width: 640px) {
            .card-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-800">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-80 dark:bg-gray-900 dark:bg-opacity-80 flex justify-center items-center z-50">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <div id="loading-message" class="text-lg font-medium">Loading...</div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-md p-4">
        <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center">
            <div class="flex items-center mb-4 sm:mb-0">
                <i class="fas fa-satellite-dish text-primary text-xl mr-2"></i>
                <h1 class="text-xl font-semibold">NTRIP CORS Station Monitor</h1>
            </div>
            <div class="flex space-x-2">
                <button id="check-all-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded flex items-center">
                    <i class="fas fa-sync-alt mr-2"></i> Check All
                </button>
                <button id="add-station-btn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded flex items-center">
                    <i class="fas fa-plus mr-2"></i> Add Station
                </button>
                <button id="settings-btn" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-3 py-2 rounded flex items-center">
                    <i class="fas fa-cog mr-2"></i> Settings
                </button>
            </div>
        </div>
    </header>

    <!-- View Tabs -->
    <div class="container mx-auto mt-4 border-b border-gray-200 dark:border-gray-700 px-4">
        <div class="flex justify-between items-center">
            <div class="flex">
                <button id="card-view-btn" class="py-2 px-4 font-medium tab-active">
                    <i class="fas fa-th-large mr-2"></i> Card View
                </button>
                <button id="map-view-btn" class="py-2 px-4 font-medium">
                    <i class="fas fa-map-marked-alt mr-2"></i> Map View
                </button>
            </div>
            <div class="text-sm text-gray-500 dark:text-gray-400">
                Last update: <span id="last-update-time">Never</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto p-4">
        <div id="card-view" class="view-container block">
            <div id="station-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 card-grid">
                <div id="station-loading" class="col-span-full text-center py-8">
                    <div class="spinner mx-auto mb-4"></div>
                    <p class="text-lg">Loading stations...</p>
                </div>
            </div>
        </div>
        
        <div id="map-view" class="view-container hidden">
            <div id="map" class="mt-4"></div>
        </div>
    </main>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center modal-transition">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="border-b border-gray-200 dark:border-gray-700 p-4 flex justify-between items-center">
                <h2 class="text-xl font-semibold">Settings</h2>
                <button data-dismiss="settings-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <div class="mb-4">
                    <label class="block font-medium mb-2">Update Interval</label>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="update-interval" value="10000" class="mr-2">
                            10 seconds
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="update-interval" value="30000" checked class="mr-2">
                            30 seconds
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="update-interval" value="60000" class="mr-2">
                            1 minute
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="update-interval" value="300000" class="mr-2">
                            5 minutes
                        </label>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block font-medium mb-2">Theme</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="theme" value="light" checked class="mr-2">
                            Light
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="theme" value="dark" class="mr-2">
                            Dark
                        </label>
                    </div>
                </div>
                
                <div class="mb-4">
                    <button id="clear-data-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                        Clear All Station Data
                    </button>
                </div>
            </div>
            <div class="border-t border-gray-200 dark:border-gray-700 p-4 text-right">
                <button id="save-settings-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                    Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Station Modal -->
    <div id="station-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center modal-transition">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="border-b border-gray-200 dark:border-gray-700 p-4 flex justify-between items-center">
                <h2 id="station-modal-title" class="text-xl font-semibold">Add Station</h2>
                <button data-dismiss="station-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <form id="station-form">
                    <input type="hidden" id="station-edit-id">
                    
                    <div class="mb-4">
                        <label for="station-id" class="block font-medium mb-2">Station ID</label>
                        <input type="text" id="station-id" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded" required>
                    </div>
                    
                    <div class="mb-4">
                        <label for="station-name" class="block font-medium mb-2">Display Name</label>
                        <input type="text" id="station-name" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded" placeholder="Optional">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block font-medium mb-2">Location</label>
                        <div id="location-map" class="mb-2"></div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Click on the map to set the location or enter coordinates manually</p>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="station-lat" class="block font-medium mb-1">Latitude</label>
                                <input type="number" id="station-lat" step="0.0001" min="-90" max="90" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded">
                            </div>
                            <div>
                                <label for="station-lng" class="block font-medium mb-1">Longitude</label>
                                <input type="number" id="station-lng" step="0.0001" min="-180" max="180" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="border-t border-gray-200 dark:border-gray-700 p-4 text-right">
                <button id="save-station-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                    Save Station
                </button>
            </div>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center modal-transition">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="border-b border-gray-200 dark:border-gray-700 p-4 flex justify-between items-center">
                <h2 class="text-xl font-semibold">Message</h2>
                <button data-dismiss="message-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <p id="message-content" class="text-center">Message here</p>
            </div>
            <div class="border-t border-gray-200 dark:border-gray-700 p-4 text-center">
                <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" data-dismiss="message-modal">
                    OK
                </button>
            </div>
        </div>
    </div>

    <script>
        // Constants and configuration
        const API_URL = 'https://asia-southeast1-cors-428306.cloudfunctions.net/getNtripData';
        let stations = [];
        let map = null;
        let locationMap = null;
        let locationMarker = null;
        let isSelectingLocation = false;
        let stationMarkers = {};
        let updateInterval = 30000; // 30 seconds default
        let updateTimer = null;
        let isEditingStation = false;
        let editingStationId = null;

        // Default station coordinates (for known stations)
        const defaultCoordinates = {
            'MLE': { lat: 4.1754, lng: 73.5093 },
            'HMLE': { lat: 4.2133, lng: 73.5566 },
            'OORR': { lat: -0.6287, lng: 73.1044 },
            'MAD': { lat: 0.5013, lng: 73.2564 },
            'SUN': { lat: 3.4825, lng: 72.8555 },
            'EYD': { lat: 5.1033, lng: 73.0707 }
        };

        // DOM Elements
        const cardViewBtn = document.getElementById('card-view-btn');
        const mapViewBtn = document.getElementById('map-view-btn');
        const cardView = document.getElementById('card-view');
        const mapView = document.getElementById('map-view');
        const stationCards = document.getElementById('station-cards');
        const addStationBtn = document.getElementById('add-station-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const checkAllBtn = document.getElementById('check-all-btn');
        const lastUpdateTime = document.getElementById('last-update-time');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingMessage = document.getElementById('loading-message');

        // Modal Elements
        const settingsModal = document.getElementById('settings-modal');
        const stationModal = document.getElementById('station-modal');
        const messageModal = document.getElementById('message-modal');
        const stationModalTitle = document.getElementById('station-modal-title');
        const stationForm = document.getElementById('station-form');
        const stationIdInput = document.getElementById('station-id');
        const stationNameInput = document.getElementById('station-name');
        const stationLatInput = document.getElementById('station-lat');
        const stationLngInput = document.getElementById('station-lng');
        const stationEditIdInput = document.getElementById('station-edit-id');
        const saveStationBtn = document.getElementById('save-station-btn');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const clearDataBtn = document.getElementById('clear-data-btn');
        const messageContent = document.getElementById('message-content');

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', () => {
            initializeDashboard();
        });

        // Dashboard initialization
        async function initializeDashboard() {
            showLoading('Initializing dashboard...');
            
            // Load settings from cookies
            loadSettings();
            
            // Apply theme
            applyTheme();
            
            // Initialize maps
            initializeMap();
            initializeLocationMap();
            
            // Load stations (from cookies first, then from API)
            await loadStations();
            
            // Start update timer
            startUpdateTimer();
            
            // Initialize event listeners
            initializeEventListeners();
            
            // Hide loading overlay
            hideLoading();
        }

        // Initialize the main map
        function initializeMap() {
            map = L.map('map').setView([3.2028, 73.2207], 7); // Maldives center
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }

        // Initialize the location selection map
        function initializeLocationMap() {
            locationMap = L.map('location-map').setView([3.2028, 73.2207], 7);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(locationMap);
            
            // Add click event for location selection
            locationMap.on('click', function(e) {
                const lat = e.latlng.lat.toFixed(4);
                const lng = e.latlng.lng.toFixed(4);
                
                // Update form fields
                stationLatInput.value = lat;
                stationLngInput.value = lng;
                
                // Update marker position
                if (locationMarker) {
                    locationMarker.setLatLng(e.latlng);
                } else {
                    locationMarker = L.marker(e.latlng).addTo(locationMap);
                }
            });
        }

        // Initialize event listeners
        function initializeEventListeners() {
            // View tab buttons
            cardViewBtn.addEventListener('click', () => switchView('card'));
            mapViewBtn.addEventListener('click', () => switchView('map'));
            
            // Modal close buttons
            document.querySelectorAll('[data-dismiss]').forEach(button => {
                const modalId = button.getAttribute('data-dismiss');
                button.addEventListener('click', () => closeModal(modalId));
            });
            
            // Action buttons
            addStationBtn.addEventListener('click', openAddStationModal);
            settingsBtn.addEventListener('click', openSettingsModal);
            checkAllBtn.addEventListener('click', checkAllStations);
            
            // Save buttons
            saveStationBtn.addEventListener('click', saveStation);
            saveSettingsBtn.addEventListener('click', saveSettings);
            clearDataBtn.addEventListener('click', confirmClearData);
            
            // Close modals when clicking outside
            window.addEventListener('click', function(event) {
                if (event.target === settingsModal) closeModal('settings-modal');
                if (event.target === stationModal) closeModal('station-modal');
                if (event.target === messageModal) closeModal('message-modal');
            });
        }

        // Switch between card and map views
        function switchView(view) {
            if (view === 'card') {
                cardView.classList.remove('hidden');
                cardView.classList.add('block');
                mapView.classList.add('hidden');
                mapView.classList.remove('block');
                cardViewBtn.classList.add('tab-active');
                mapViewBtn.classList.remove('tab-active');
            } else {
                cardView.classList.add('hidden');
                cardView.classList.remove('block');
                mapView.classList.remove('hidden');
                mapView.classList.add('block');
                cardViewBtn.classList.remove('tab-active');
                mapViewBtn.classList.add('tab-active');
                
                // Refresh map when switching to map view
                if (map) {
                    setTimeout(() => {
                        map.invalidateSize();
                        fitMapToMarkers();
                    }, 100);
                }
            }
        }

        // Load stations from cookies and API
        async function loadStations() {
            // First try to load from cookies
            const savedStations = getStationsFromCookies();
            
            if (savedStations && savedStations.length > 0) {
                stations = savedStations;
                renderStations();
                checkAllStations();
            } else {
                // If no stations in cookies, load from API
                try {
                    const apiStations = await loadStationsFromAPI();
                    if (apiStations && apiStations.length > 0) {
                        stations = apiStations;
                        saveStationsToCookies(stations);
                        renderStations();
                        checkAllStations();
                    } else {
                        showNotification('No stations found. Add stations manually.', 'warning');
                    }
                } catch (error) {
                    console.error('Error loading stations:', error);
                    showNotification('Error loading stations: ' + error.message, 'error');
                }
            }
        }

        // Load stations from API
        async function loadStationsFromAPI() {
            try {
                showLoading('Loading stations...');
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`Failed to fetch stations: ${response.status}`);
                }
                
                const apiStations = await response.json();
                
                // Process stations from API
                return apiStations.map(station => ({
                    id: station.name,
                    name: formatStationName(station.name),
                    status: 'unknown',
                    lastUpdate: null,
                    uptime: 0,
                    lat: getDefaultLatitude(station.name),
                    lng: getDefaultLongitude(station.name),
                    statusHistory: []
                }));
            } catch (error) {
                console.error('Error loading stations:', error);
                showNotification('Error loading stations: ' + error.message, 'error');
                return [];
            } finally {
                hideLoading();
            }
        }

        // Format station name for display
        function formatStationName(id) {
            // If it's just the ID, make it more readable
            return id.replace(/_/g, ' ');
        }

        // Get default latitude for a station if available
        function getDefaultLatitude(stationId) {
            return defaultCoordinates[stationId] ? defaultCoordinates[stationId].lat : null;
        }

        // Get default longitude for a station if available
        function getDefaultLongitude(stationId) {
            return defaultCoordinates[stationId] ? defaultCoordinates[stationId].lng : null;
        }

        // Render all stations to the UI
        function renderStations() {
            // Clear existing content
            stationCards.innerHTML = '';
            clearMapMarkers();
            
            if (stations.length === 0) {
                stationCards.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <p class="text-lg">No stations found. Add a station to get started.</p>
                    </div>
                `;
                return;
            }
            
            // Add all stations
            stations.forEach(station => {
                addStationCard(station);
                addStationMarker(station);
            });
            
            // Fit map to markers
            fitMapToMarkers();
        }

        // Add a station card to the UI
        function addStationCard(station) {
            const card = document.createElement('div');
            card.className = 'bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden transition-transform hover:shadow-lg hover:-translate-y-1 card';
            card.id = `station-card-${station.id}`;
            
            // Determine status class and text
            let statusClass = 'unknown';
            let statusText = 'Unknown';
            
            if (station.status === 'online') {
                statusClass = 'online';
                statusText = 'Online';
            } else if (station.status === 'offline') {
                statusClass = 'offline';
                statusText = 'Offline';
            }
            
            // Determine uptime class
            let uptimeClass = 'uptime-low';
            if (station.uptime >= 90) {
                uptimeClass = 'uptime-high';
            } else if (station.uptime >= 70) {
                uptimeClass = 'uptime-medium';
            }
            
            // Format last update time
            const lastUpdateText = station.lastUpdate 
                ? new Date(station.lastUpdate).toLocaleTimeString()
                : 'Never';
            
            // Create card HTML
            card.innerHTML = `
                <div class="border-b border-gray-200 dark:border-gray-700 p-3 flex justify-between items-center">
                    <div>
                        <h3 class="font-semibold text-lg">${station.name}</h3>
                        <div class="text-xs text-gray-500 dark:text-gray-400">ID: ${station.id}</div>
                    </div>
                    <div class="flex space-x-2">
                        <button class="edit-station-btn text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200" data-station-id="${station.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-station-btn text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200" data-station-id="${station.id}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="p-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">Status</div>
                            <div class="font-medium flex items-center">
                                <span class="status-dot ${statusClass} mr-2"></span>
                                ${statusText}
                            </div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">Uptime</div>
                            <div class="font-medium">${station.uptime}%</div>
                            <div class="uptime-bar">
                                <div class="uptime-bar-fill ${uptimeClass}" style="width: ${station.uptime}%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">Coordinates</div>
                            <div class="font-medium text-sm">
                                ${station.lat && station.lng 
                                    ? `${parseFloat(station.lat).toFixed(4)}, ${parseFloat(station.lng).toFixed(4)}`
                                    : 'Not set'}
                            </div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">Last Check</div>
                            <div class="font-medium">${lastUpdateText}</div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 border-t border-gray-200 dark:border-gray-600 text-center">
                    <button class="check-station-btn w-full py-2 text-blue-600 dark:text-blue-400 hover:bg-gray-100 dark:hover:bg-gray-600 font-medium" data-station-id="${station.id}">
                        Check Status
                    </button>
                </div>
            `;
            
            stationCards.appendChild(card);
            
            // Add event listeners to buttons
            card.querySelector('.edit-station-btn').addEventListener('click', () => {
                openEditStationModal(station.id);
            });
            
            card.querySelector('.delete-station-btn').addEventListener('click', () => {
                confirmDeleteStation(station.id);
            });
            
            card.querySelector('.check-station-btn').addEventListener('click', () => {
                checkStationStatus(station);
            });
        }

        // Add a station marker to the map
        function addStationMarker(station) {
            if (!station.lat || !station.lng) return;
            
            const markerColor = station.status === 'online' ? 'green' : (station.status === 'offline' ? 'red' : 'orange');
            
            // Create marker icon
            const markerIcon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="background-color: ${markerColor}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>`,
                iconSize: [12, 12],
                iconAnchor: [6, 6]
            });
            
            // Create marker
            const marker = L.marker([station.lat, station.lng], {
                icon: markerIcon,
                title: station.name
            }).addTo(map);
            
            // Add popup
            marker.bindPopup(`
                <div class="text-center">
                    <strong>${station.name}</strong><br>
                    ID: ${station.id}<br>
                    Status: ${station.status}<br>
                    Uptime: ${station.uptime}%
                </div>
            `);
            
            // Store marker for later use
            stationMarkers[station.id] = marker;
        }

        // Clear all markers from the map
        function clearMapMarkers() {
            for (const id in stationMarkers) {
                map.removeLayer(stationMarkers[id]);
            }
            stationMarkers = {};
        }

        // Fit map to show all markers
        function fitMapToMarkers() {
            const markers = Object.values(stationMarkers);
            if (markers.length > 0) {
                const markerBounds = L.featureGroup(markers).getBounds();
                map.fitBounds(markerBounds, { padding: [30, 30] });
            }
        }

        // Update a station's card and marker
        function updateStationUI(station) {
            // Update card
            const card = document.getElementById(`station-card-${station.id}`);
            if (card) {
                // Remove existing card
                card.remove();
                // Add updated card
                addStationCard(station);
            }
            
            // Update marker
            if (stationMarkers[station.id]) {
                map.removeLayer(stationMarkers[station.id]);
            }
            
            addStationMarker(station);
        }

        // Check status of all stations
        async function checkAllStations() {
            if (stations.length === 0) {
                showNotification('No stations to check.', 'info');
                return;
            }
            
            showLoading('Checking station status...');
            
            // Create an array of promises for each station check
            const checkPromises = stations.map(station => 
                simulateStationCheck(station)
                    .then(isOnline => {
                        station.status = isOnline ? 'online' : 'offline';
                        station.lastUpdate = Date.now();
                        
                        // Update uptime
                        updateStationUptime(station, isOnline);
                        
                        // Update UI
                        updateStationUI(station);
                        
                        return station;
                    })
                    .catch(error => {
                        console.error(`Error checking station ${station.id}:`, error);
                        station.status = 'unknown';
                        station.lastUpdate = Date.now();
                        updateStationUI(station);
                        return station;
                    })
            );
            
            // Wait for all checks to complete
            await Promise.all(checkPromises);
            
            // Update last check time
            lastUpdateTime.textContent = new Date().toLocaleTimeString();
            
            // Save updated stations to cookies
            saveStationsToCookies(stations);
            
            hideLoading();
        }

        // Check status of a single station
        async function checkStationStatus(station) {
            showLoading(`Checking ${station.id}...`);
            
            try {
                const isOnline = await simulateStationCheck(station);
                
                station.status = isOnline ? 'online' : 'offline';
                station.lastUpdate = Date.now();
                
                // Update uptime
                updateStationUptime(station, isOnline);
                
                // Update UI
                updateStationUI(station);
                
                // Update last check time
                lastUpdateTime.textContent = new Date().toLocaleTimeString();
                
                // Save updated stations to cookies
                saveStationsToCookies(stations);
                
                hideLoading();
            } catch (error) {
                console.error(`Error checking station ${station.id}:`, error);
                station.status = 'unknown';
                station.lastUpdate = Date.now();
                updateStationUI(station);
                hideLoading();
                showNotification(`Error checking station ${station.id}: ${error.message}`, 'error');
            }
        }

        // Simulate checking a station's status (used in demo mode)
        async function simulateStationCheck(station) {
            // In a real application, this would connect to the actual NTRIP server
            // For this demo, we'll simulate a response based on the station ID
            
            // Simulate network delay
            await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 1000));
            
            // Determine if station should be online (70% chance for most stations)
            const onlineChance = station.id === 'RYNAN_Base' ? 0.95 : 0.7;
            return Math.random() < onlineChance;
        }

        // Update a station's uptime percentage
        function updateStationUptime(station, isOnline) {
            // Initialize history if it doesn't exist
            if (!station.statusHistory) {
                station.statusHistory = [];
            }
            
            // Add current status to history
            station.statusHistory.push({
                timestamp: Date.now(),
                status: isOnline ? 'online' : 'offline'
            });
            
            // Limit history size (keep last 100 entries)
            if (station.statusHistory.length > 100) {
                station.statusHistory.shift();
            }
            
            // Calculate uptime percentage
            const totalChecks = station.statusHistory.length;
            const successfulChecks = station.statusHistory.filter(entry => entry.status === 'online').length;
            station.uptime = totalChecks > 0 ? Math.round((successfulChecks / totalChecks) * 100) : 0;
            
            return station.uptime;
        }

        // Start the automatic update timer
        function startUpdateTimer() {
            // Clear existing timer if any
            if (updateTimer) {
                clearInterval(updateTimer);
            }
            
            // Start new timer
            updateTimer = setInterval(checkAllStations, updateInterval);
        }

        // Open the add station modal
        function openAddStationModal() {
            // Reset form
            stationForm.reset();
            stationEditIdInput.value = '';
            stationModalTitle.textContent = 'Add Station';
            isEditingStation = false;
            
            // Reset location map
            if (locationMarker) {
                locationMap.removeLayer(locationMarker);
                locationMarker = null;
            }
            
            // Center location map
            locationMap.setView([3.2028, 73.2207], 7);
            setTimeout(() => locationMap.invalidateSize(), 100);
            
            // Show modal
            openModal('station-modal');
        }

        // Open the edit station modal
        function openEditStationModal(stationId) {
            const station = stations.find(s => s.id === stationId);
            if (!station) return;
            
            // Set form values
            stationIdInput.value = station.id;
            stationNameInput.value = station.name || '';
            stationLatInput.value = station.lat || '';
            stationLngInput.value = station.lng || '';
            stationEditIdInput.value = station.id;
            
            // Set modal title
            stationModalTitle.textContent = 'Edit Station';
            isEditingStation = true;
            editingStationId = station.id;
            
            // Set location marker if coordinates exist
            if (locationMarker) {
                locationMap.removeLayer(locationMarker);
                locationMarker = null;
            }
            
            if (station.lat && station.lng) {
                const latlng = L.latLng(station.lat, station.lng);
                locationMarker = L.marker(latlng).addTo(locationMap);
                locationMap.setView(latlng, 10);
            } else {
                locationMap.setView([3.2028, 73.2207], 7);
            }
            
            // Show modal
            openModal('station-modal');
            
            // Refresh map
            setTimeout(() => locationMap.invalidateSize(), 100);
        }

        // Open the settings modal
        function openSettingsModal() {
            // Set form values based on current settings
            document.querySelector(`input[name="update-interval"][value="${updateInterval}"]`).checked = true;
            
            const theme = document.body.classList.contains('dark') ? 'dark' : 'light';
            document.querySelector(`input[name="theme"][value="${theme}"]`).checked = true;
            
            // Show modal
            openModal('settings-modal');
        }

        // Save the current settings
        function saveSettings() {
            // Get update interval
            const intervalInput = document.querySelector('input[name="update-interval"]:checked');
            if (intervalInput) {
                updateInterval = parseInt(intervalInput.value);
                
                // Restart timer with new interval
                startUpdateTimer();
            }
            
            // Get theme
            const themeInput = document.querySelector('input[name="theme"]:checked');
            if (themeInput) {
                const theme = themeInput.value;
                
                // Apply theme
                if (theme === 'dark') {
                    document.body.classList.add('dark');
                } else {
                    document.body.classList.remove('dark');
                }
            }
            
            // Save settings to cookies
            const settings = {
                updateInterval,
                theme: document.body.classList.contains('dark') ? 'dark' : 'light'
            };
            
            setCookie('dashboard_settings', JSON.stringify(settings), 180);
            
            // Close modal
            closeModal('settings-modal');
            
            showNotification('Settings saved successfully.', 'success');
        }

        // Save a new or edited station
        function saveStation() {
            // Validate form
            const stationId = stationIdInput.value.trim();
            if (!stationId) {
                showNotification('Station ID is required.', 'error');
                return;
            }
            
            const stationName = stationNameInput.value.trim() || stationId;
            const stationLat = parseFloat(stationLatInput.value) || null;
            const stationLng = parseFloat(stationLngInput.value) || null;
            
            if (isEditingStation) {
                // Editing existing station
                const stationIndex = stations.findIndex(s => s.id === editingStationId);
                if (stationIndex !== -1) {
                    // Update station
                    const updatedStation = {
                        ...stations[stationIndex],
                        id: stationId,
                        name: stationName,
                        lat: stationLat,
                        lng: stationLng
                    };
                    
                    // Remove old station
                    stations.splice(stationIndex, 1);
                    
                    // Add updated station
                    stations.push(updatedStation);
                }
            } else {
                // Check if station ID already exists
                if (stations.some(s => s.id === stationId)) {
                    showNotification('A station with this ID already exists.', 'error');
                    return;
                }
                
                // Create new station
                const newStation = {
                    id: stationId,
                    name: stationName,
                    status: 'unknown',
                    lastUpdate: null,
                    uptime: 0,
                    lat: stationLat,
                    lng: stationLng,
                    statusHistory: []
                };
                
                // Add to stations array
                stations.push(newStation);
            }
            
            // Save to cookies
            saveStationsToCookies(stations);
            
            // Refresh UI
            renderStations();
            
            // Close modal
            closeModal('station-modal');
            
            // Show notification
            showNotification(
                isEditingStation 
                    ? 'Station updated successfully.' 
                    : 'Station added successfully.',
                'success'
            );
            
            // Check the new/updated station
            const station = stations.find(s => s.id === stationId);
            if (station) {
                checkStationStatus(station);
            }
        }

        // Confirm deletion of a station
        function confirmDeleteStation(stationId) {
            const station = stations.find(s => s.id === stationId);
            if (!station) return;
            
            messageContent.textContent = `Are you sure you want to delete the station "${station.name}" (${station.id})?`;
            
            // Set up the OK button to delete the station
            const okButton = messageModal.querySelector('[data-dismiss="message-modal"]');
            
            // Store the original onclick
            const originalOnClick = okButton.onclick;
            
            // Set new onclick
            okButton.onclick = function() {
                deleteStation(stationId);
                closeModal('message-modal');
                
                // Restore original onclick
                okButton.onclick = originalOnClick;
            };
            
            openModal('message-modal');
        }

        // Delete a station
        function deleteStation(stationId) {
            const stationIndex = stations.findIndex(s => s.id === stationId);
            if (stationIndex !== -1) {
                // Remove from array
                stations.splice(stationIndex, 1);
                
                // Save to cookies
                saveStationsToCookies(stations);
                
                // Refresh UI
                renderStations();
                
                showNotification('Station deleted successfully.', 'success');
            }
        }

        // Confirm clearing all station data
        function confirmClearData() {
            messageContent.textContent = 'Are you sure you want to clear all station data? This cannot be undone.';
            
            // Set up the OK button to clear data
            const okButton = messageModal.querySelector('[data-dismiss="message-modal"]');
            
            // Store the original onclick
            const originalOnClick = okButton.onclick;
            
            // Set new onclick
            okButton.onclick = function() {
                clearAllStationData();
                closeModal('message-modal');
                
                // Restore original onclick
                okButton.onclick = originalOnClick;
            };
            
            openModal('message-modal');
        }

        // Clear all station data
        function clearAllStationData() {
            // Clear stations array
            stations = [];
            
            // Clear cookies
            deleteCookie('stations');
            
            // Refresh UI
            renderStations();
            
            // Close settings modal
            closeModal('settings-modal');
            
            showNotification('All station data has been cleared.', 'success');
        }

        // Load settings from cookies
        function loadSettings() {
            const settingsJson = getCookie('dashboard_settings');
            if (settingsJson) {
                try {
                    const settings = JSON.parse(settingsJson);
                    
                    // Apply update interval
                    if (settings.updateInterval) {
                        updateInterval = settings.updateInterval;
                    }
                    
                    // Apply theme
                    if (settings.theme === 'dark') {
                        document.body.classList.add('dark');
                    } else {
                        document.body.classList.remove('dark');
                    }
                } catch (e) {
                    console.error('Error parsing settings from cookie:', e);
                }
            }
        }

        // Apply the current theme
        function applyTheme() {
            // This function is called after loading settings
            // Additional theme-specific logic can be added here if needed
        }

        // Show the loading overlay with a message
        function showLoading(message) {
            loadingMessage.textContent = message || 'Loading...';
            loadingOverlay.classList.remove('hidden');
            loadingOverlay.classList.add('flex');
        }

        // Hide the loading overlay
        function hideLoading() {
            loadingOverlay.classList.add('hidden');
            loadingOverlay.classList.remove('flex');
        }

        // Show a notification message
        function showNotification(message, type = 'info') {
            messageContent.textContent = message;
            
            // Add type-specific styling if needed
            messageContent.className = 'text-center';
            
            if (type === 'error') {
                messageContent.classList.add('text-red-600');
            } else if (type === 'success') {
                messageContent.classList.add('text-green-600');
            } else if (type === 'warning') {
                messageContent.classList.add('text-yellow-600');
            }
            
            openModal('message-modal');
        }

        // Open a modal
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                
                // Refresh map if it's the station modal
                if (modalId === 'station-modal' && locationMap) {
                    setTimeout(() => locationMap.invalidateSize(), 100);
                }
            }
        }

        // Close a modal
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        // Save stations to cookies
        function saveStationsToCookies(stations) {
            setCookie('stations', JSON.stringify(stations), 180); // 180 days expiry
        }

        // Get stations from cookies
        function getStationsFromCookies() {
            const stationsJson = getCookie('stations');
            if (stationsJson) {
                try {
                    return JSON.parse(stationsJson);
                } catch (e) {
                    console.error('Error parsing stations from cookie:', e);
                    return null;
                }
            }
            return null;
        }

        // Set a cookie
        function setCookie(name, value, days) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${encodeURIComponent(value)};expires=${expires.toUTCString()};path=/`;
        }

        // Get a cookie value
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return decodeURIComponent(c.substring(nameEQ.length, c.length));
            }
            return null;
        }

        // Delete a cookie
        function deleteCookie(name) {
            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
        }
    </script>
</body>
</html>
