<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WSCORS Station Monitor</title>
    
    <!-- External libraries via jsdelivr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.js"></script>
    
    <style>
        :root {
            --primary-color: #3763f4;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-color: #dee2e6;
            --text-color: #333;
            --background-color: #f5f7fa;
            --card-background: #fff;
            --header-background: #fff;
            --modal-background: #fff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--background-color);
        }

        .dark-theme {
            --text-color: #f8f9fa;
            --background-color: #2c3e50;
            --card-background: #34495e;
            --header-background: #1a2533;
            --border-color: #4b6584;
            --modal-background: #34495e;
        }

        /* Header Styles */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background-color: var(--header-background);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Status counter */
        .station-counter {
            background-color: var(--card-background);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-top: 1rem;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .counter-item {
            text-align: center;
            padding: 0.5rem 1rem;
        }

        .counter-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.2rem;
        }

        .counter-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .counter-online {
            color: var(--success-color);
        }

        .counter-total {
            color: var(--primary-color);
        }

        /* Button Styles */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.1s;
            background-color: var(--light-color);
            color: var(--text-color);
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn.success {
            background-color: var(--success-color);
            color: white;
        }

        .btn.danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn.warning {
            background-color: var(--warning-color);
            color: var(--dark-color);
        }

        /* View Tabs */
        .view-tabs {
            display: flex;
            padding: 0 2rem;
            margin-top: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .tab-btn {
            padding: 0.5rem 1rem;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab-btn.active {
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

        .last-update {
            margin-left: auto;
            padding: 0.5rem 0;
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        /* Main Content */
        main {
            padding: 1rem 2rem;
        }

        .view-container {
            display: none;
        }

        .view-container.active {
            display: block;
        }

        /* Card View */
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .station-card {
            background-color: var(--card-background);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .station-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .card-id {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 0.2rem;
        }

        .card-actions {
            display: flex;
            gap: 0.5rem;
        }

        .card-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: var(--text-color);
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .card-actions button:hover {
            opacity: 1;
        }

        .card-body {
            padding: 1rem;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem 1rem;
        }

        .status-item {
            margin-bottom: 0.5rem;
        }

        .status-label {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-bottom: 0.2rem;
        }

        .status-value {
            font-weight: 500;
        }

        /* Enhanced status indicator */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-weight: 600;
            margin: 0.5rem 0;
            width: fit-content;
        }

        .status-online {
            background-color: rgba(40, 167, 69, 0.2);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }

        .status-offline {
            background-color: rgba(220, 53, 69, 0.2);
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }

        .status-unknown {
            background-color: rgba(255, 193, 7, 0.2);
            color: #856404;
            border: 1px solid var(--warning-color);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-dot.online {
            background-color: var(--success-color);
        }

        .status-dot.offline {
            background-color: var(--danger-color);
        }

        .status-dot.unknown {
            background-color: var(--warning-color);
        }

        .card-footer {
            padding: 1rem;
            background-color: rgba(0, 0, 0, 0.03);
            border-top: 1px solid var(--border-color);
        }

        .ip-access-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .ip-button {
            padding: 0.5rem;
            text-align: center;
            background-color: var(--primary-color);
            color: white;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .ip-button:hover {
            background-color: #2a4ebc;
        }

        .check-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-weight: 500;
            padding: 0.5rem;
            width: 100%;
            transition: background-color 0.2s;
            margin-top: 0.5rem;
        }

        .check-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        /* Map View */
        #map, #location-map {
            height: 500px;
            border-radius: 8px;
            margin-top: 1rem;
        }

        #location-map {
            height: 300px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow: auto;
        }

        .modal-content {
            background-color: var(--modal-background);
            margin: 10% auto;
            padding: 0;
            border-radius: 8px;
            max-width: 600px;
            animation: modalFadeIn 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .close {
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            color: var(--text-color);
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .close:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 1rem;
        }

        .modal-footer {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            text-align: right;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-row {
            display: flex;
            gap: 1rem;
        }

        .form-row .form-group {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--card-background);
            color: var(--text-color);
        }

        .help-text {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 0.5rem;
        }

        .radio-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-weight: normal;
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .dark-theme #loading-overlay {
            background-color: rgba(0, 0, 0, 0.8);
        }

        .loading-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .dark-theme .spinner {
            border-color: rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary-color);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-message {
            text-align: center;
            margin-top: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        /* Uptime Styles */
        .uptime-bar {
            height: 6px;
            background-color: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 0.2rem;
        }

        .uptime-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s;
        }

        .uptime-high {
            background-color: var(--success-color);
        }

        .uptime-medium {
            background-color: var(--warning-color);
        }

        .uptime-low {
            background-color: var(--danger-color);
        }

        /* Add Station Card */
        .add-station-card {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: var(--card-background);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            height: 100%;
            min-height: 200px;
            text-align: center;
            border: 2px dashed var(--border-color);
            transition: border-color 0.2s, transform 0.2s;
            cursor: pointer;
        }

        .add-station-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .add-station-card .icon {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
            background-color: rgba(55, 99, 244, 0.1);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .add-station-card .title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .add-station-card .description {
            font-size: 0.9rem;
            opacity: 0.7;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .card-container {
                grid-template-columns: 1fr;
            }
            
            .view-tabs {
                padding: 0 1rem;
            }
            
            main {
                padding: 1rem;
            }
            
            .modal-content {
                margin: 5% auto;
                width: 95%;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0.5rem;
            }

            .station-counter {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div id="loading-message">Loading...</div>
        </div>
    </div>

    <header>
        <div class="logo">
            <i class="fas fa-satellite-dish"></i>
            <h1>NTRIP CORS Station Monitor</h1>
        </div>
        <div class="actions">
            <button id="check-all-btn" class="btn primary">
                <i class="fas fa-sync-alt"></i> Check All
            </button>
            <button id="add-station-btn" class="btn success">
                <i class="fas fa-plus"></i> Add Station
            </button>
            <button id="settings-btn" class="btn">
                <i class="fas fa-cog"></i> Settings
            </button>
        </div>
    </header>
    
    <div class="container mx-auto px-4">
        <div class="station-counter">
            <div class="counter-item">
                <div id="online-count" class="counter-value counter-online">0</div>
                <div class="counter-label">Online Stations</div>
            </div>
            <div class="counter-item">
                <div id="total-count" class="counter-value counter-total">0</div>
                <div class="counter-label">Total Stations</div>
            </div>
            <div class="counter-item">
                <div id="uptime-average" class="counter-value">0%</div>
                <div class="counter-label">Average Uptime</div>
            </div>
        </div>
    </div>
    
    <div class="view-tabs">
        <button id="card-view-btn" class="tab-btn active">
            <i class="fas fa-th-large"></i> Card View
        </button>
        <button id="map-view-btn" class="tab-btn">
            <i class="fas fa-map-marked-alt"></i> Map View
        </button>
        <div class="last-update">
            Last update: <span id="last-update-time">Never</span>
        </div>
    </div>

    <main>
        <div id="card-view" class="view-container active">
            <div id="station-cards" class="card-container">
                <div id="station-loading" class="loading-message">
                    <div class="spinner"></div>
                    <p>Loading stations...</p>
                </div>
            </div>
        </div>
        
        <div id="map-view" class="view-container">
            <div id="map"></div>
        </div>
    </main>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <span class="close" data-dismiss="settings-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Update Interval</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="update-interval" value="10000">
                            10 seconds
                        </label>
                        <label>
                            <input type="radio" name="update-interval" value="30000" checked>
                            30 seconds
                        </label>
                        <label>
                            <input type="radio" name="update-interval" value="60000">
                            1 minute
                        </label>
                        <label>
                            <input type="radio" name="update-interval" value="300000">
                            5 minutes
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Theme</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="theme" value="light" checked>
                            Light
                        </label>
                        <label>
                            <input type="radio" name="theme" value="dark">
                            Dark
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <button id="clear-data-btn" class="btn danger">
                        Clear All Station Data
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button id="save-settings-btn" class="btn primary">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Station Modal -->
    <div id="station-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="station-modal-title">Add Station</h2>
                <span class="close" data-dismiss="station-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="station-form">
                    <input type="hidden" id="station-edit-id">
                    
                    <div class="form-group">
                        <label for="station-id">Station ID</label>
                        <input type="text" id="station-id" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="station-name">Display Name</label>
                        <input type="text" id="station-name" placeholder="Optional">
                    </div>

                    <div class="form-group">
                        <label for="gnss-ip">GNSS IP</label>
                        <input type="text" id="gnss-ip" placeholder="e.g., 10.64.50.20">
                    </div>

                    <div class="form-group">
                        <label for="rut-ip">RUT IP</label>
                        <input type="text" id="rut-ip" placeholder="e.g., 10.64.50.1">
                    </div>
                    
                    <div class="form-group">
                        <label>Location</label>
                        <div id="location-map"></div>
                        <p class="help-text">Click on the map to set the location or enter coordinates manually</p>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="station-lat">Latitude</label>
                                <input type="number" id="station-lat" step="0.0001" min="-90" max="90">
                            </div>
                            <div class="form-group">
                                <label for="station-lng">Longitude</label>
                                <input type="number" id="station-lng" step="0.0001" min="-180" max="180">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="save-station-btn" class="btn primary">Save Station</button>
            </div>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="message-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Message</h2>
                <span class="close" data-dismiss="message-modal">&times;</span>
            </div>
            <div class="modal-body">
                <p id="message-content">Message here</p>
            </div>
            <div class="modal-footer">
                <button class="btn primary" data-dismiss="message-modal">OK</button>
            </div>
        </div>
    </div>

    <script>
        // Constants and configuration
        const API_URL = 'https://asia-southeast1-cors-428306.cloudfunctions.net/getNtripData';
        let stations = [];
        let map = null;
        let locationMap = null;
        let locationMarker = null;
        let isSelectingLocation = false;
        let stationMarkers = {};
        let updateInterval = 30000; // 30 seconds default
        let updateTimer = null;
        let isEditingStation = false;
        let editingStationId = null;

        // Preset station data with IP information
        const stationData = [
            { id: "KDM", name: "KDM", gnssIp: "10.64.80.167", rutIp: "10.64.80.0", lat: 3.9071, lng: 73.5185 },
            { id: "MAD", name: "MAD", gnssIp: "10.64.60.167", rutIp: "10.64.60.1", lat: 0.5013, lng: 73.2564 },
            { id: "MLE", name: "MLE", gnssIp: "10.64.50.20", rutIp: "10.64.50.1", lat: 4.1754, lng: 73.5093 },
            { id: "SUN", name: "SUN", gnssIp: "10.64.10.167", rutIp: "10.64.10.1", lat: 3.4825, lng: 72.8555 },
            { id: "FOH", name: "FOH", gnssIp: "10.64.70.167", rutIp: "10.64.70.1", lat: 3.3014, lng: 73.2156 },
            { id: "HMLE", name: "HMLE", gnssIp: "172.17.10.167", rutIp: "172.17.10.1", lat: 4.2133, lng: 73.5566 },
            { id: "OORR", name: "OORR", gnssIp: "110.64.40.167", rutIp: "110.64.40.1", lat: -0.6287, lng: 73.1044 },
            { id: "EYD", name: "EYD", gnssIp: "10.64.90.167", rutIp: "10.64.90.1", lat: 5.1033, lng: 73.0707 }
        ];

        // DOM Elements
        const cardViewBtn = document.getElementById('card-view-btn');
        const mapViewBtn = document.getElementById('map-view-btn');
        const cardView = document.getElementById('card-view');
        const mapView = document.getElementById('map-view');
        const stationCards = document.getElementById('station-cards');
        const addStationBtn = document.getElementById('add-station-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const checkAllBtn = document.getElementById('check-all-btn');
        const lastUpdateTime = document.getElementById('last-update-time');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingMessage = document.getElementById('loading-message');
        const onlineCountElement = document.getElementById('online-count');
        const totalCountElement = document.getElementById('total-count');
        const uptimeAverageElement = document.getElementById('uptime-average');

        // Modal Elements
        const settingsModal = document.getElementById('settings-modal');
        const stationModal = document.getElementById('station-modal');
        const messageModal = document.getElementById('message-modal');
        const stationModalTitle = document.getElementById('station-modal-title');
        const stationForm = document.getElementById('station-form');
        const stationIdInput = document.getElementById('station-id');
        const stationNameInput = document.getElementById('station-name');
        const gnssIpInput = document.getElementById('gnss-ip');
        const rutIpInput = document.getElementById('rut-ip');
        const stationLatInput = document.getElementById('station-lat');
        const stationLngInput = document.getElementById('station-lng');
        const stationEditIdInput = document.getElementById('station-edit-id');
        const saveStationBtn = document.getElementById('save-station-btn');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const clearDataBtn = document.getElementById('clear-data-btn');
        const messageContent = document.getElementById('message-content');

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', () => {
            initializeDashboard();
        });

        // Dashboard initialization
        async function initializeDashboard() {
            showLoading('Initializing dashboard...');
            
            // Load settings from cookies
            loadSettings();
            
            // Initialize map
            initializeMap();
            initializeLocationMap();
            
            // Load stations (from cookies first, then from preset data)
            await loadStations();
            
            // Start update timer
            startUpdateTimer();
            
            // Initialize event listeners
            initializeEventListeners();
            
            // Hide loading overlay
            hideLoading();
        }

        // Initialize the main map
        function initializeMap() {
            map = L.map('map').setView([3.2028, 73.2207], 7); // Maldives center
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }

        // Initialize the location selection map
        function initializeLocationMap() {
            locationMap = L.map('location-map').setView([3.2028, 73.2207], 7);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(locationMap);
            
            // Add click event for location selection
            locationMap.on('click', function(e) {
                isSelectingLocation = true;
                const lat = e.latlng.lat.toFixed(4);
                const lng = e.latlng.lng.toFixed(4);
                
                // Update form fields
                stationLatInput.value = lat;
                stationLngInput.value = lng;
                
                // Update marker position
                if (locationMarker) {
                    locationMarker.setLatLng(e.latlng);
                } else {
                    locationMarker = L.marker(e.latlng).addTo(locationMap);
                }
            });
        }

        // Initialize event listeners
        function initializeEventListeners() {
            // View tab buttons
            cardViewBtn.addEventListener('click', () => switchView('card'));
            mapViewBtn.addEventListener('click', () => switchView('map'));
            
            // Modal close buttons
            document.querySelectorAll('.close, [data-dismiss]').forEach(element => {
                element.addEventListener('click', (e) => {
                    const modalId = e.target.dataset.dismiss || e.target.closest('.modal').id;
                    document.getElementById(modalId).style.display = 'none';
                });
            });
            
            // Settings button
            settingsBtn.addEventListener('click', () => {
                settingsModal.style.display = 'block';
            });
            
            // Add station button
            addStationBtn.addEventListener('click', () => {
                openAddStationModal();
            });
            
            // Check all button
            checkAllBtn.addEventListener('click', () => {
                checkAllStations();
            });
            
            // Save settings button
            saveSettingsBtn.addEventListener('click', () => {
                saveSettings();
                settingsModal.style.display = 'none';
            });
            
            // Clear data button
            clearDataBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to clear all station data? This cannot be undone.')) {
                    clearAllData();
                }
            });
            
            // Save station button
            saveStationBtn.addEventListener('click', () => {
                saveStation();
            });
            
            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
        }

        // Switch between card and map views
        function switchView(view) {
            if (view === 'card') {
                cardViewBtn.classList.add('active');
                mapViewBtn.classList.remove('active');
                cardView.classList.add('active');
                mapView.classList.remove('active');
            } else {
                cardViewBtn.classList.remove('active');
                mapViewBtn.classList.add('active');
                cardView.classList.remove('active');
                mapView.classList.add('active');
                
                // Make sure the map renders correctly when showing it
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
            }
        }

        // Load stations from cookies or preset data
        async function loadStations() {
            // Try to load from cookies first
            const savedStations = getStationsFromCookies();
            
            if (savedStations && savedStations.length > 0) {
                stations = savedStations;
                renderStations();
                updateStationCounters();
                return;
            }
            
            // If no stations in cookies, load from preset data
            stations = stationData.map(station => ({
                id: station.id,
                name: station.name || station.id,
                status: 'unknown',
                lastUpdate: null,
                uptime: 0,
                lat: station.lat,
                lng: station.lng,
                gnssIp: station.gnssIp,
                rutIp: station.rutIp,
                statusHistory: []
            }));
            
            // Also try to load from API
            try {
                showLoading('Loading stations from API...');
                const response = await fetch(API_URL);
                if (response.ok) {
                    const apiStations = await response.json();
                    
                    // Merge API stations with our preset data
                    apiStations.forEach(apiStation => {
                        // Check if this station already exists in our stations array
                        const existingIndex = stations.findIndex(s => s.id === apiStation.name);
                        
                        if (existingIndex === -1) {
                            // If it doesn't exist, add it with default values
                            const presetStation = stationData.find(s => s.id === apiStation.name);
                            stations.push({
                                id: apiStation.name,
                                name: apiStation.name,
                                status: 'unknown',
                                lastUpdate: null,
                                uptime: 0,
                                lat: presetStation?.lat || null,
                                lng: presetStation?.lng || null,
                                gnssIp: presetStation?.gnssIp || null,
                                rutIp: presetStation?.rutIp || null,
                                statusHistory: []
                            });
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading stations from API:', error);
            } finally {
                hideLoading();
            }
            
            renderStations();
            updateStationCounters();
            saveStationsToCookies();
        }

        // Render all stations in the card view and on the map
        function renderStations() {
            renderStationCards();
            renderStationMarkers();
        }

        // Render station cards in the card view
        function renderStationCards() {
            stationCards.innerHTML = '';
            
            if (stations.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'loading-message';
                emptyMessage.innerHTML = '<p>No stations found. Click "Add Station" to add your first station.</p>';
                stationCards.appendChild(emptyMessage);
                return;
            }
            
            stations.forEach(station => {
                const card = createStationCard(station);
                stationCards.appendChild(card);
            });
            
            // Add the "Add Station" card
            const addCard = document.createElement('div');
            addCard.className = 'add-station-card';
            addCard.innerHTML = `
                <div class="icon"><i class="fas fa-plus"></i></div>
                <div class="title">Add New Station</div>
                <div class="description">Click to add a new CORS station</div>
            `;
            addCard.addEventListener('click', () => {
                openAddStationModal();
            });
            stationCards.appendChild(addCard);
        }

        // Create a station card
        function createStationCard(station) {
            const card = document.createElement('div');
            card.className = 'station-card';
            card.id = `card-${station.id}`;
            
            // Status class based on station status
            let statusClass = 'status-unknown';
            let statusText = 'Unknown';
            
            if (station.status === 'online') {
                statusClass = 'status-online';
                statusText = 'Online';
            } else if (station.status === 'offline') {
                statusClass = 'status-offline';
                statusText = 'Offline';
            }
            
            // Format date if available
            let lastUpdateText = 'Never';
            if (station.lastUpdate) {
                const date = new Date(station.lastUpdate);
                lastUpdateText = date.toLocaleString();
            }
            
            // Uptime bar class
            let uptimeClass = 'uptime-low';
            if (station.uptime >= 90) {
                uptimeClass = 'uptime-high';
            } else if (station.uptime >= 70) {
                uptimeClass = 'uptime-medium';
            }
            
            card.innerHTML = `
                <div class="card-header">
                    <div>
                        <div class="card-title">${station.name || station.id}</div>
                        <div class="card-id">${station.id}</div>
                    </div>
                    <div class="card-actions">
                        <button class="edit-station-btn" title="Edit Station">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-station-btn" title="Delete Station">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="status-indicator ${statusClass}">
                        <span class="status-dot ${station.status}"></span>
                        ${statusText}
                    </div>
                    
                    <div class="status-grid">
                        <div class="status-item">
                            <div class="status-label">Uptime</div>
                            <div class="status-value">${station.uptime}%</div>
                            <div class="uptime-bar">
                                <div class="uptime-bar-fill ${uptimeClass}" style="width: ${station.uptime}%"></div>
                            </div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Last Update</div>
                            <div class="status-value">${lastUpdateText}</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Latitude</div>
                            <div class="status-value">${station.lat ? station.lat.toFixed(4) : 'N/A'}</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Longitude</div>
                            <div class="status-value">${station.lng ? station.lng.toFixed(4) : 'N/A'}</div>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="ip-access-buttons">
                        ${station.gnssIp ? `<a href="http://${station.gnssIp}" target="_blank" class="ip-button">GNSS Access</a>` : ''}
                        ${station.rutIp ? `<a href="http://${station.rutIp}" target="_blank" class="ip-button">RUT Access</a>` : ''}
                    </div>
                    <button class="check-btn">
                        <i class="fas fa-sync-alt"></i> Check Status
                    </button>
                </div>
            `;
            
            // Add event listeners
            card.querySelector('.edit-station-btn').addEventListener('click', () => {
                openEditStationModal(station);
            });
            
            card.querySelector('.delete-station-btn').addEventListener('click', () => {
                if (confirm(`Are you sure you want to delete station ${station.name || station.id}?`)) {
                    deleteStation(station.id);
                }
            });
            
            card.querySelector('.check-btn').addEventListener('click', () => {
                checkStationStatus(station);
            });
            
            return card;
        }

        // Render station markers on the map
        function renderStationMarkers() {
            // Clear existing markers
            for (const id in stationMarkers) {
                map.removeLayer(stationMarkers[id]);
                delete stationMarkers[id];
            }
            
            // Add markers for all stations
            stations.forEach(station => {
                if (station.lat && station.lng) {
                    const markerColor = station.status === 'online' ? 'green' : 
                                       (station.status === 'offline' ? 'red' : 'orange');
                    
                    const markerIcon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="background-color: ${markerColor}; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white;"></div>`,
                        iconSize: [16, 16],
                        iconAnchor: [8, 8]
                    });
                    
                    const marker = L.marker([station.lat, station.lng], {
                        icon: markerIcon,
                        title: station.name || station.id
                    }).addTo(map);
                    
                    marker.bindPopup(`
                        <strong>${station.name || station.id}</strong><br>
                        Status: ${station.status}<br>
                        Uptime: ${station.uptime}%<br>
                        ${station.gnssIp ? `GNSS IP: ${station.gnssIp}<br>` : ''}
                        ${station.rutIp ? `RUT IP: ${station.rutIp}` : ''}
                    `);
                    
                    stationMarkers[station.id] = marker;
                }
            });
        }

        // Open the add station modal
        function openAddStationModal() {
            // Reset form
            stationForm.reset();
            stationEditIdInput.value = '';
            stationModalTitle.textContent = 'Add Station';
            isEditingStation = false;
            
            // Reset location marker
            if (locationMarker) {
                locationMap.removeLayer(locationMarker);
                locationMarker = null;
            }
            
            // Center location map on Maldives
            locationMap.setView([3.2028, 73.2207], 7);
            
            // Show modal
            stationModal.style.display = 'block';
            
            // Make sure the map renders correctly
            setTimeout(() => {
                locationMap.invalidateSize();
            }, 100);
        }

        // Open the edit station modal
        function openEditStationModal(station) {
            // Fill form with station data
            stationIdInput.value = station.id;
            stationNameInput.value = station.name || '';
            gnssIpInput.value = station.gnssIp || '';
            rutIpInput.value = station.rutIp || '';
            stationLatInput.value = station.lat || '';
            stationLngInput.value = station.lng || '';
            stationEditIdInput.value = station.id;
            stationModalTitle.textContent = 'Edit Station';
            isEditingStation = true;
            editingStationId = station.id;
            
            // Update location marker
            if (station.lat && station.lng) {
                const latlng = L.latLng(station.lat, station.lng);
                
                if (locationMarker) {
                    locationMarker.setLatLng(latlng);
                } else {
                    locationMarker = L.marker(latlng).addTo(locationMap);
                }
                
                locationMap.setView(latlng, 10);
            } else {
                // Reset location marker
                if (locationMarker) {
                    locationMap.removeLayer(locationMarker);
                    locationMarker = null;
                }
                
                // Center location map on Maldives
                locationMap.setView([3.2028, 73.2207], 7);
            }
            
            // Show modal
            stationModal.style.display = 'block';
            
            // Make sure the map renders correctly
            setTimeout(() => {
                locationMap.invalidateSize();
            }, 100);
        }

        // Save station (add new or update existing)
        function saveStation() {
            const id = stationIdInput.value.trim();
            const name = stationNameInput.value.trim() || id;
            const gnssIp = gnssIpInput.value.trim();
            const rutIp = rutIpInput.value.trim();
            const lat = parseFloat(stationLatInput.value) || null;
            const lng = parseFloat(stationLngInput.value) || null;
            
            if (!id) {
                showMessage('Station ID is required.');
                return;
            }
            
            if (isEditingStation) {
                // Update existing station
                const stationIndex = stations.findIndex(s => s.id === editingStationId);
                
                if (stationIndex !== -1) {
                    const updatedStation = {
                        ...stations[stationIndex],
                        id,
                        name,
                        gnssIp,
                        rutIp,
                        lat,
                        lng
                    };
                    
                    stations[stationIndex] = updatedStation;
                }
            } else {
                // Check if station with this ID already exists
                if (stations.some(s => s.id === id)) {
                    showMessage(`Station with ID "${id}" already exists.`);
                    return;
                }
                
                // Add new station
                stations.push({
                    id,
                    name,
                    gnssIp,
                    rutIp,
                    status: 'unknown',
                    lastUpdate: null,
                    uptime: 0,
                    lat,
                    lng,
                    statusHistory: []
                });
            }
            
            // Save stations to cookies
            saveStationsToCookies();
            
            // Render stations
            renderStations();
            updateStationCounters();
            
            // Close modal
            stationModal.style.display = 'none';
            
            // Check status of the new/updated station
            const station = stations.find(s => s.id === id);
            if (station) {
                checkStationStatus(station);
            }
        }

        // Delete a station
        function deleteStation(stationId) {
            stations = stations.filter(s => s.id !== stationId);
            
            // Save stations to cookies
            saveStationsToCookies();
            
            // Render stations
            renderStations();
            updateStationCounters();
        }

        // Check status of a single station
        async function checkStationStatus(station) {
            // Update card to show checking status
            const card = document.getElementById(`card-${station.id}`);
            if (card) {
                const statusIndicator = card.querySelector('.status-indicator');
                if (statusIndicator) {
                    statusIndicator.className = 'status-indicator status-unknown';
                    statusIndicator.innerHTML = '<span class="status-dot unknown"></span> Checking...';
                }
            }
            
            try {
                // Simulate status check (in real scenario, this would call your API)
                // For demo purposes, we'll randomize the status
                const isOnline = Math.random() > 0.3; // 70% chance of being online
                
                // Update station status
                station.status = isOnline ? 'online' : 'offline';
                station.lastUpdate = Date.now();
                
                // Update station uptime
                updateStationUptime(station, isOnline);
                
                // Update station card
                if (card) {
                    const newCard = createStationCard(station);
                    card.replaceWith(newCard);
                }
                
                // Update station marker
                updateStationMarker(station);
                
                // Save stations to cookies
                saveStationsToCookies();
                
                // Update counters
                updateStationCounters();
                
                return isOnline;
            } catch (error) {
                console.error(`Error checking status for ${station.id}:`, error);
                
                // Update station status to offline on error
                station.status = 'offline';
                station.lastUpdate = Date.now();
                
                // Update station uptime
                updateStationUptime(station, false);
                
                // Update station card
                if (card) {
                    const newCard = createStationCard(station);
                    card.replaceWith(newCard);
                }
                
                // Update station marker
                updateStationMarker(station);
                
                // Save stations to cookies
                saveStationsToCookies();
                
                // Update counters
                updateStationCounters();
                
                return false;
            }
        }

        // Update station marker on the map
        function updateStationMarker(station) {
            if (!station.lat || !station.lng) {
                return;
            }
            
            // Remove old marker
            if (stationMarkers[station.id]) {
                map.removeLayer(stationMarkers[station.id]);
                delete stationMarkers[station.id];
            }
            
            // Add new marker
            const markerColor = station.status === 'online' ? 'green' : 
                               (station.status === 'offline' ? 'red' : 'orange');
            
            const markerIcon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="background-color: ${markerColor}; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white;"></div>`,
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });
            
            const marker = L.marker([station.lat, station.lng], {
                icon: markerIcon,
                title: station.name || station.id
            }).addTo(map);
            
            marker.bindPopup(`
                <strong>${station.name || station.id}</strong><br>
                Status: ${station.status}<br>
                Uptime: ${station.uptime}%<br>
                ${station.gnssIp ? `GNSS IP: ${station.gnssIp}<br>` : ''}
                ${station.rutIp ? `RUT IP: ${station.rutIp}` : ''}
            `);
            
            stationMarkers[station.id] = marker;
        }

        // Check status of all stations
        async function checkAllStations() {
            showLoading('Checking all stations...');
            
            // Update last update time
            lastUpdateTime.textContent = new Date().toLocaleString();
            
            // Check each station
            for (const station of stations) {
                await checkStationStatus(station);
            }
            
            hideLoading();
        }

        // Update station uptime
        function updateStationUptime(station, isOnline) {
            // Initialize history if it doesn't exist
            if (!station.statusHistory) {
                station.statusHistory = [];
            }
            
            // Add current status to history
            station.statusHistory.push({
                timestamp: Date.now(),
                status: isOnline ? 'online' : 'offline'
            });
            
            // Limit history size (keep last 100 entries)
            if (station.statusHistory.length > 100) {
                station.statusHistory.shift();
            }
            
            // Calculate uptime percentage
            const totalChecks = station.statusHistory.length;
            const successfulChecks = station.statusHistory.filter(entry => entry.status === 'online').length;
            station.uptime = totalChecks > 0 ? Math.round((successfulChecks / totalChecks) * 100) : 0;
            
            return station.uptime;
        }

        // Update station counters at the top
        function updateStationCounters() {
            const total = stations.length;
            const online = stations.filter(s => s.status === 'online').length;
            const totalUptime = stations.reduce((sum, station) => sum + station.uptime, 0);
            const averageUptime = total > 0 ? Math.round(totalUptime / total) : 0;
            
            totalCountElement.textContent = total;
            onlineCountElement.textContent = online;
            uptimeAverageElement.textContent = averageUptime + '%';
        }

        // Save settings to cookies
        function saveSettings() {
            // Get selected update interval
            const intervalRadios = document.getElementsByName('update-interval');
            for (const radio of intervalRadios) {
                if (radio.checked) {
                    updateInterval = parseInt(radio.value);
                    break;
                }
            }
            
            // Get selected theme
            const themeRadios = document.getElementsByName('theme');
            let selectedTheme = 'light';
            for (const radio of themeRadios) {
                if (radio.checked) {
                    selectedTheme = radio.value;
                    break;
                }
            }
            
            // Save to cookies
            const expiryDate = new Date();
            expiryDate.setMonth(expiryDate.getMonth() + 6); // 6 months expiry
            
            document.cookie = `updateInterval=${updateInterval}; expires=${expiryDate.toUTCString()}; path=/`;
            document.cookie = `theme=${selectedTheme}; expires=${expiryDate.toUTCString()}; path=/`;
            
            // Apply theme
            if (selectedTheme === 'dark') {
                document.body.classList.add('dark-theme');
            } else {
                document.body.classList.remove('dark-theme');
            }
            
            // Restart update timer
            startUpdateTimer();
            
            // Show success message
            showMessage('Settings saved successfully.');
        }

        // Load settings from cookies
        function loadSettings() {
            // Load update interval
            const intervalCookie = getCookie('updateInterval');
            if (intervalCookie) {
                updateInterval = parseInt(intervalCookie);
                
                // Update radio buttons
                const intervalRadios = document.getElementsByName('update-interval');
                for (const radio of intervalRadios) {
                    if (parseInt(radio.value) === updateInterval) {
                        radio.checked = true;
                        break;
                    }
                }
            }
            
            // Load theme
            const themeCookie = getCookie('theme');
            if (themeCookie) {
                // Update radio buttons
                const themeRadios = document.getElementsByName('theme');
                for (const radio of themeRadios) {
                    if (radio.value === themeCookie) {
                        radio.checked = true;
                        break;
                    }
                }
                
                // Apply theme
                if (themeCookie === 'dark') {
                    document.body.classList.add('dark-theme');
                } else {
                    document.body.classList.remove('dark-theme');
                }
            }
        }

        // Clear all data
        function clearAllData() {
            stations = [];
            
            // Clear cookies
            document.cookie = 'stations=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            
            // Render stations
            renderStations();
            updateStationCounters();
            
            // Show success message
            showMessage('All station data has been cleared.');
        }

        // Start update timer
        function startUpdateTimer() {
            // Clear existing timer
            if (updateTimer) {
                clearInterval(updateTimer);
            }
            
            // Start new timer
            updateTimer = setInterval(() => {
                checkAllStations();
            }, updateInterval);
        }

        // Save stations to cookies
        function saveStationsToCookies() {
            const expiryDate = new Date();
            expiryDate.setMonth(expiryDate.getMonth() + 6); // 6 months expiry
            document.cookie = `stations=${JSON.stringify(stations)}; expires=${expiryDate.toUTCString()}; path=/`;
        }

        // Get stations from cookies
        function getStationsFromCookies() {
            const cookieValue = getCookie('stations');
            if (cookieValue) {
                try {
                    return JSON.parse(cookieValue);
                } catch (e) {
                    console.error('Error parsing stations from cookies:', e);
                    return null;
                }
            }
            return null;
        }

        // Helper function to get cookie by name
        function getCookie(name) {
            const cookieArr = document.cookie.split(';');
            
            for (let i = 0; i < cookieArr.length; i++) {
                const cookiePair = cookieArr[i].split('=');
                
                if (name === cookiePair[0].trim()) {
                    return decodeURIComponent(cookiePair[1]);
                }
            }
            
            return null;
        }

        // Show a message in the message modal
        function showMessage(message) {
            messageContent.textContent = message;
            messageModal.style.display = 'block';
        }

        // Show loading overlay
        function showLoading(message = 'Loading...') {
            loadingMessage.textContent = message;
            loadingOverlay.style.display = 'flex';
        }

        // Hide loading overlay
        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }
    </script>
</body>
</html>
