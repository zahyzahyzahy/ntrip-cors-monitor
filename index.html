<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WSCORS Station Monitor</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            transition: all 0.3s ease;
        }
        .status-indicator.online {
            box-shadow: 0 0 10px #22c55e;
            background-color: #22c55e;
        }
        .status-indicator.offline {
            box-shadow: 0 0 10px #ef4444;
            background-color: #ef4444;
        }
        .status-indicator.unknown {
            box-shadow: 0 0 10px #f59e0b;
            background-color: #f59e0b;
        }
        .status-indicator.large {
            width: 30px;
            height: 30px;
        }
        .card-status-bar {
            width: 100%;
            height: 10px;
            border-radius: 5px;
            transition: all 0.3s;
        }
        .pulse {
            animation: pulse-animation 2s infinite;
        }
        @keyframes pulse-animation {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .ip-button {
            transition: all 0.2s;
        }
        .ip-button:hover {
            transform: translateY(-2px);
        }
        .uptime-bar {
            height: 6px;
            background-color: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }
        .uptime-fill {
            height: 100%;
            transition: width 0.5s;
        }
        #map, #location-map {
            height: 600px;
            z-index: 1;
        }
        #location-map {
            height: 300px;
        }
        /* Modal animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-content {
            animation: fadeIn 0.3s ease-out;
        }
        /* Dark mode adjustments */
        .dark .status-indicator.online {
            box-shadow: 0 0 15px #22c55e;
        }
        .dark .status-indicator.offline {
            box-shadow: 0 0 15px #ef4444;
        }
        .dark .status-indicator.unknown {
            box-shadow: 0 0 15px #f59e0b;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen dark:bg-gray-900 dark:text-white">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-80 dark:bg-gray-900 dark:bg-opacity-80 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="inline-block w-12 h-12 border-4 border-t-blue-600 border-gray-200 rounded-full animate-spin"></div>
            <p id="loading-message" class="mt-4 text-lg font-medium">Loading dashboard...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-md">
        <div class="container mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row md:justify-between md:items-center space-y-4 md:space-y-0">
                <div class="flex items-center">
                    <i class="fas fa-satellite-dish text-blue-600 text-3xl mr-3"></i>
                    <h1 class="text-2xl font-bold">NTRIP CORS Station Monitor</h1>
                </div>
                <div class="flex flex-wrap items-center gap-3">
                    <!-- Station Counters -->
                    <div class="flex items-center bg-gray-100 dark:bg-gray-700 rounded-lg px-4 py-2 mr-2">
                        <div class="flex items-center">
                            <i class="fas fa-server text-gray-600 dark:text-gray-300 mr-2"></i>
                            <span class="font-medium">Total: </span>
                            <span id="total-stations" class="ml-1 font-bold">0</span>
                        </div>
                        <div class="mx-2 text-gray-400">|</div>
                        <div class="flex items-center">
                            <i class="fas fa-plug text-green-500 mr-2"></i>
                            <span class="font-medium">Online: </span>
                            <span id="online-stations" class="ml-1 font-bold text-green-500">0</span>
                        </div>
                    </div>
                    
                    <button id="check-all-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center transition">
                        <i class="fas fa-sync-alt mr-2"></i> Check All
                    </button>
                    <button id="add-station-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center transition">
                        <i class="fas fa-plus mr-2"></i> Add Station
                    </button>
                    <button id="settings-btn" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg flex items-center transition">
                        <i class="fas fa-cog mr-2"></i> Settings
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- View Tabs -->
    <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center">
                <div class="flex">
                    <button id="card-view-btn" class="px-6 py-3 font-medium border-b-2 border-blue-600 text-blue-600 dark:text-blue-400 transition">
                        <i class="fas fa-th-large mr-2"></i> Card View
                    </button>
                    <button id="map-view-btn" class="px-6 py-3 font-medium border-b-2 border-transparent hover:text-gray-700 dark:hover:text-gray-300 transition">
                        <i class="fas fa-map-marked-alt mr-2"></i> Map View
                    </button>
                </div>
                <div class="text-gray-500 dark:text-gray-400 text-sm">
                    <span class="mr-2">Last update:</span>
                    <span id="last-update-time" class="font-medium">Never</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Card View -->
        <div id="card-view" class="view-container block">
            <div id="station-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Station cards will be added here -->
                <div id="station-loading" class="col-span-full text-center py-10">
                    <div class="inline-block w-10 h-10 border-4 border-t-blue-600 border-gray-200 rounded-full animate-spin mb-4"></div>
                    <p class="text-lg text-gray-600 dark:text-gray-400">Loading stations...</p>
                </div>
            </div>
        </div>
        
        <!-- Map View -->
        <div id="map-view" class="view-container hidden">
            <div id="map" class="rounded-lg shadow-lg"></div>
        </div>
    </main>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 p-4">
                <h2 class="text-xl font-bold">Settings</h2>
                <button data-dismiss="settings-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-6">
                    <label class="block mb-2 font-medium">Update Interval</label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <label class="inline-flex items-center p-2 border rounded hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer">
                            <input type="radio" name="update-interval" value="10000" class="mr-2">
                            <span>10 seconds</span>
                        </label>
                        <label class="inline-flex items-center p-2 border rounded hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer">
                            <input type="radio" name="update-interval" value="30000" checked class="mr-2">
                            <span>30 seconds</span>
                        </label>
                        <label class="inline-flex items-center p-2 border rounded hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer">
                            <input type="radio" name="update-interval" value="60000" class="mr-2">
                            <span>1 minute</span>
                        </label>
                        <label class="inline-flex items-center p-2 border rounded hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer">
                            <input type="radio" name="update-interval" value="300000" class="mr-2">
                            <span>5 minutes</span>
                        </label>
                    </div>
                </div>
                
                <div class="mb-6">
                    <label class="block mb-2 font-medium">Theme</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="inline-flex items-center p-2 border rounded hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer">
                            <input type="radio" name="theme" value="light" checked class="mr-2">
                            <span>Light</span>
                        </label>
                        <label class="inline-flex items-center p-2 border rounded hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer">
                            <input type="radio" name="theme" value="dark" class="mr-2">
                            <span>Dark</span>
                        </label>
                    </div>
                </div>
                
                <div class="mt-6">
                    <button id="clear-data-btn" class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                        Clear All Station Data
                    </button>
                </div>
            </div>
            <div class="border-t border-gray-200 dark:border-gray-700 p-4 text-right">
                <button id="save-settings-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                    Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Station Modal -->
    <div id="station-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4">
            <div class="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 p-4">
                <h2 id="station-modal-title" class="text-xl font-bold">Add Station</h2>
                <button data-dismiss="station-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <form id="station-form">
                    <input type="hidden" id="station-edit-id">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <div class="mb-4">
                                <label for="station-id" class="block mb-2 font-medium">Station ID</label>
                                <input type="text" id="station-id" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required>
                            </div>
                            
                            <div class="mb-4">
                                <label for="station-name" class="block mb-2 font-medium">Display Name</label>
                                <input type="text" id="station-name" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Optional">
                            </div>
                            
                            <div class="mb-4">
                                <label for="gnss-ip" class="block mb-2 font-medium">GNSS IP</label>
                                <input type="text" id="gnss-ip" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="e.g. 10.64.80.167">
                            </div>
                            
                            <div class="mb-4">
                                <label for="rut-ip" class="block mb-2 font-medium">RUT IP</label>
                                <input type="text" id="rut-ip" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="e.g. 10.64.80.0">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block mb-2 font-medium">Location</label>
                            <div id="location-map" class="rounded mb-2"></div>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Click on the map to set the location or enter coordinates manually</p>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="station-lat" class="block mb-1 font-medium">Latitude</label>
                                    <input type="number" id="station-lat" step="0.0001" min="-90" max="90" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                                </div>
                                <div>
                                    <label for="station-lng" class="block mb-1 font-medium">Longitude</label>
                                    <input type="number" id="station-lng" step="0.0001" min="-180" max="180" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="border-t border-gray-200 dark:border-gray-700 p-4 text-right">
                <button id="save-station-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded">
                    Save Station
                </button>
            </div>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 p-4">
                <h2 class="text-xl font-bold">Message</h2>
                <button data-dismiss="message-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <p id="message-content" class="text-gray-800 dark:text-gray-200">Message here</p>
            </div>
            <div class="border-t border-gray-200 dark:border-gray-700 p-4 text-right">
                <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" data-dismiss="message-modal">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Access IP Modal -->
    <div id="access-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 p-4">
                <h2 id="access-modal-title" class="text-xl font-bold">Access Station</h2>
                <button data-dismiss="access-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <p class="mb-3 text-gray-700 dark:text-gray-300">
                        You are about to access <span id="access-station-name" class="font-semibold"></span> via:
                    </p>
                    <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg flex items-center">
                        <i class="fas fa-network-wired text-blue-600 mr-3"></i>
                        <span id="access-ip" class="text-lg font-mono"></span>
                    </div>
                </div>
                <div class="bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 p-3 rounded-lg">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span>Note: This requires that you are connected to the Zerotier network.</span>
                </div>
            </div>
            <div class="border-t border-gray-200 dark:border-gray-700 p-4 flex justify-between">
                <button class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded" data-dismiss="access-modal">
                    Cancel
                </button>
                <a id="access-link" href="#" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded inline-flex items-center">
                    <i class="fas fa-external-link-alt mr-2"></i> Access
                </a>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg transition-opacity duration-300 opacity-0 hidden">
        <span id="toast-message"></span>
    </div>

    <script>
        // Constants and configuration
        const API_URL = 'https://asia-southeast1-cors-428306.cloudfunctions.net/getNtripData';
        
        // Station data with IP information
        const initialStations = [
            { id: 'KDM', name: 'KDM', gnssIP: '10.64.80.167', rutIP: '10.64.80.0', lat: 2.9815, lng: 73.5532 },
            { id: 'MAD', name: 'MAD', gnssIP: '10.64.60.167', rutIP: '10.64.60.1', lat: 0.5013, lng: 73.2564 },
            { id: 'MLE', name: 'MLE', gnssIP: '10.64.50.20', rutIP: '10.64.50.1', lat: 4.1754, lng: 73.5093 },
            { id: 'SUN', name: 'SUN', gnssIP: '10.64.10.167', rutIP: '10.64.10.1', lat: 3.4825, lng: 72.8555 },
            { id: 'FOH', name: 'FOH', gnssIP: '10.64.70.167', rutIP: '10.64.70.1', lat: 1.8347, lng: 73.3946 },
            { id: 'HMLE', name: 'HMLE', gnssIP: '172.17.10.167', rutIP: '172.17.10.1', lat: 4.2133, lng: 73.5566 },
            { id: 'OORR', name: 'OORR', gnssIP: '110.64.40.167', rutIP: '110.64.40.1', lat: -0.6287, lng: 73.1044 },
            { id: 'EYD', name: 'EYD', gnssIP: 'Kuri IP', rutIP: '10.64.90.1', lat: 5.1033, lng: 73.0707 }
        ];
        
        // Variables
        let stations = [];
        let map = null;
        let locationMap = null;
        let locationMarker = null;
        let isSelectingLocation = false;
        let stationMarkers = {};
        let updateInterval = 30000; // Default: 30 seconds
        let updateTimer = null;
        let isEditingStation = false;
        let editingStationId = null;
        let darkMode = false;

        // DOM Elements
        const cardViewBtn = document.getElementById('card-view-btn');
        const mapViewBtn = document.getElementById('map-view-btn');
        const cardView = document.getElementById('card-view');
        const mapView = document.getElementById('map-view');
        const stationCards = document.getElementById('station-cards');
        const stationLoading = document.getElementById('station-loading');
        const totalStationsCounter = document.getElementById('total-stations');
        const onlineStationsCounter = document.getElementById('online-stations');
        const addStationBtn = document.getElementById('add-station-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const checkAllBtn = document.getElementById('check-all-btn');
        const lastUpdateTime = document.getElementById('last-update-time');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingMessage = document.getElementById('loading-message');

        // Initialize the dashboard when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            initializeDashboard();
        });

        // Initialize the dashboard
        async function initializeDashboard() {
            showLoading('Initializing dashboard...');
            
            // Load settings from cookies
            loadSettings();
            
            // Apply theme
            applyTheme();
            
            // Initialize maps
            initializeMap();
            initializeLocationMap();
            
            // Load stations (from cookies first, then from API)
            await loadStations();
            
            // Start status updates
            startUpdateTimer();
            
            // Setup event listeners
            setupEventListeners();
            
            // Hide loading overlay
            hideLoading();
        }

        // Initialize the main map
        function initializeMap() {
            map = L.map('map').setView([3.2028, 73.2207], 7); // Maldives center
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }

        // Initialize the location selection map
        function initializeLocationMap() {
            locationMap = L.map('location-map').setView([3.2028, 73.2207], 7);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(locationMap);
            
            // Add click event for selecting station location
            locationMap.on('click', function(e) {
                const lat = e.latlng.lat.toFixed(4);
                const lng = e.latlng.lng.toFixed(4);
                
                // Update form fields
                document.getElementById('station-lat').value = lat;
                document.getElementById('station-lng').value = lng;
                
                // Update marker position
                if (locationMarker) {
                    locationMarker.setLatLng(e.latlng);
                } else {
                    locationMarker = L.marker(e.latlng).addTo(locationMap);
                }
            });
        }

        // Load stations from cookies and API
        async function loadStations() {
            // Try to load from cookies first
            const savedStations = getStationsFromCookies();
            
            if (savedStations && savedStations.length > 0) {
                stations = savedStations;
                renderStations();
                updateCounters();
            } else {
                // If no saved stations, load initial data
                stations = initialStations.map(station => ({
                    ...station,
                    status: 'unknown',
                    lastUpdate: null,
                    uptime: 0,
                    statusHistory: []
                }));
                
                // Save to cookies and render
                saveStationsToCookies();
                renderStations();
                updateCounters();
            }
            
            // Get up-to-date list from the API
            try {
                const response = await fetch(API_URL);
                if (response.ok) {
                    const apiStations = await response.json();
                    
                    // Make sure all API stations exist in our list
                    apiStations.forEach(apiStation => {
                        const exists = stations.some(s => s.id === apiStation.name);
                        if (!exists) {
                            const defaultStation = initialStations.find(s => s.id === apiStation.name);
                            
                            stations.push({
                                id: apiStation.name,
                                name: apiStation.name,
                                gnssIP: defaultStation ? defaultStation.gnssIP : '',
                                rutIP: defaultStation ? defaultStation.rutIP : '',
                                lat: defaultStation ? defaultStation.lat : null,
                                lng: defaultStation ? defaultStation.lng : null,
                                status: 'unknown',
                                lastUpdate: null,
                                uptime: 0,
                                statusHistory: []
                            });
                        }
                    });
                    
                    // Remove stations that don't exist in the API response
                    //stations = stations.filter(station => 
                    //    apiStations.some(apiStation => apiStation.name === station.id)
                    //);
                    
                    saveStationsToCookies();
                    renderStations();
                    updateCounters();
                }
            } catch (error) {
                console.error('Error loading stations from API:', error);
                showToast('Failed to fetch station list from API');
            }
            
            // Check status of all stations
            checkAllStations();
        }

        // Render all stations in both card and map views
        function renderStations() {
            renderStationCards();
            renderStationMarkers();
        }

        // Render station cards
        function renderStationCards() {
            stationLoading.style.display = 'none';
            stationCards.innerHTML = '';
            
            if (stations.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'col-span-full text-center py-10';
                emptyMessage.innerHTML = `
                    <i class="fas fa-satellite-dish text-gray-400 text-5xl mb-4"></i>
                    <p class="text-lg text-gray-600 dark:text-gray-400">No stations available</p>
                    <button id="add-first-station-btn" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-plus mr-2"></i> Add Your First Station
                    </button>
                `;
                stationCards.appendChild(emptyMessage);
                
                // Add event listener
                document.getElementById('add-first-station-btn').addEventListener('click', () => {
                    openAddStationModal();
                });
                
                return;
            }
            
            // Sort stations: online first, then offline, then unknown
            const sortedStations = [...stations].sort((a, b) => {
                const statusOrder = { 'online': 0, 'offline': 1, 'unknown': 2 };
                return statusOrder[a.status] - statusOrder[b.status];
            });
            
            // Create card for each station
            sortedStations.forEach(station => {
                const card = createStationCard(station);
                stationCards.appendChild(card);
            });
        }

        // Create a station card
        function createStationCard(station) {
            const card = document.createElement('div');
            card.className = 'bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden transition transform hover:-translate-y-1 hover:shadow-lg';
            
            // Status bar at the top of the card
            const statusColor = getStatusColor(station.status);
            
            card.innerHTML = `
                <div class="card-status-bar bg-${statusColor}-500"></div>
                <div class="p-4">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold">${station.name || station.id}</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400">${station.id}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button class="edit-station-btn text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200" data-id="${station.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-station-btn text-gray-500 hover:text-red-600 dark:text-gray-400 dark:hover:text-red-400" data-id="${station.id}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex items-center mb-4">
                        <span class="status-indicator large ${station.status}"></span>
                        <span class="font-medium ${station.status === 'online' ? 'text-green-600 dark:text-green-400' : station.status === 'offline' ? 'text-red-600 dark:text-red-400' : 'text-yellow-600 dark:text-yellow-400'}">
                            ${station.status.charAt(0).toUpperCase() + station.status.slice(1)}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Last Check</p>
                            <p class="font-medium">${station.lastUpdate ? formatDate(station.lastUpdate) : 'Never'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Uptime</p>
                            <p class="font-medium">${station.uptime}%</p>
                            <div class="uptime-bar mt-1">
                                <div class="uptime-fill bg-${getUptimeColor(station.uptime)}-500" style="width: ${station.uptime}%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Location</p>
                            <p class="font-medium">${station.lat && station.lng ? `${station.lat.toFixed(4)}, ${station.lng.toFixed(4)}` : 'Not set'}</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 mt-4">
                        ${station.gnssIP ? `
                        <button class="access-gnss-btn ip-button bg-blue-100 hover:bg-blue-200 dark:bg-blue-900 dark:hover:bg-blue-800 text-blue-700 dark:text-blue-300 p-2 rounded flex items-center justify-center text-sm" data-id="${station.id}">
                            <i class="fas fa-satellite-dish mr-2"></i> GNSS IP
                        </button>
                        ` : ''}
                        
                        ${station.rutIP ? `
                        <button class="access-rut-btn ip-button bg-purple-100 hover:bg-purple-200 dark:bg-purple-900 dark:hover:bg-purple-800 text-purple-700 dark:text-purple-300 p-2 rounded flex items-center justify-center text-sm" data-id="${station.id}">
                            <i class="fas fa-network-wired mr-2"></i> RUT IP
                        </button>
                        ` : ''}
                    </div>
                </div>
                <div class="px-4 py-3 bg-gray-50 dark:bg-gray-700 border-t border-gray-200 dark:border-gray-600">
                    <button class="check-station-btn w-full text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 font-medium transition" data-id="${station.id}">
                        <i class="fas fa-sync-alt mr-2"></i> Check Status
                    </button>
                </div>
            `;
            
            // Add event listeners
            card.querySelector('.check-station-btn').addEventListener('click', () => {
                checkStationStatus(station.id);
            });
            
            card.querySelector('.edit-station-btn').addEventListener('click', () => {
                openEditStationModal(station.id);
            });
            
            card.querySelector('.delete-station-btn').addEventListener('click', () => {
                confirmDeleteStation(station.id);
            });
            
            if (station.gnssIP) {
                card.querySelector('.access-gnss-btn').addEventListener('click', () => {
                    openAccessModal(station.id, 'gnss');
                });
            }
            
            if (station.rutIP) {
                card.querySelector('.access-rut-btn').addEventListener('click', () => {
                    openAccessModal(station.id, 'rut');
                });
            }
            
            return card;
        }

        // Render station markers on the map
        function renderStationMarkers() {
            // Clear existing markers
            for (const markerId in stationMarkers) {
                if (stationMarkers.hasOwnProperty(markerId)) {
                    map.removeLayer(stationMarkers[markerId]);
                    delete stationMarkers[markerId];
                }
            }
            
            // Add markers for stations with coordinates
            stations.forEach(station => {
                if (station.lat && station.lng) {
                    const markerColor = station.status === 'online' ? 'green' : 
                                        station.status === 'offline' ? 'red' : 'orange';
                    
                    // Create marker
                    const marker = L.marker([station.lat, station.lng], {
                        title: station.name || station.id,
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div class="status-indicator ${station.status}" style="width: 24px; height: 24px; box-shadow: 0 0 10px var(--tw-shadow-color);"></div>`,
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        })
                    }).addTo(map);
                    
                    // Add popup
                    marker.bindPopup(`
                        <div class="text-center">
                            <div class="font-bold text-lg">${station.name || station.id}</div>
                            <div class="mb-2">${station.id}</div>
                            <div class="flex items-center justify-center mb-1">
                                <span class="status-indicator ${station.status}" style="width: 10px; height: 10px; display: inline-block; margin-right: 5px;"></span>
                                <span>${station.status.charAt(0).toUpperCase() + station.status.slice(1)}</span>
                            </div>
                            <div class="text-sm">Uptime: ${station.uptime}%</div>
                            ${station.lastUpdate ? `<div class="text-xs text-gray-500 mt-1">Last update: ${formatDate(station.lastUpdate)}</div>` : ''}
                        </div>
                    `);
                    
                    // Store marker
                    stationMarkers[station.id] = marker;
                }
            });
        }

        // Check status of all stations
        async function checkAllStations() {
            showToast('Checking all stations...');
            
            for (const station of stations) {
                await checkStationStatus(station.id);
            }
            
            updateLastUpdateTime();
            updateCounters();
            showToast('Status check complete');
        }

        // Check status of a single station
        async function checkStationStatus(stationId) {
            const stationIndex = stations.findIndex(s => s.id === stationId);
            if (stationIndex === -1) return;
            
            try {
                // In a real scenario, we would call the API to check status
                // For demo, we'll simulate status checks with random responses
                const isOnline = Math.random() > 0.3; // 70% chance of being online
                
                // Update station status
                stations[stationIndex].status = isOnline ? 'online' : 'offline';
                stations[stationIndex].lastUpdate = new Date();
                
                // Update status history and calculate uptime
                updateStationUptime(stationIndex, isOnline);
                
                // Save to cookies
                saveStationsToCookies();
                
                // Update UI
                renderStations();
                updateCounters();
                
                return isOnline;
            } catch (error) {
                console.error(`Error checking status for ${stationId}:`, error);
                
                // Mark as offline in case of error
                stations[stationIndex].status = 'offline';
                stations[stationIndex].lastUpdate = new Date();
                
                // Update status history
                updateStationUptime(stationIndex, false);
                
                // Save to cookies
                saveStationsToCookies();
                
                // Update UI
                renderStations();
                updateCounters();
                
                return false;
            }
        }

        // Update station uptime percentage
        function updateStationUptime(stationIndex, isOnline) {
            const station = stations[stationIndex];
            
            // Initialize history array if it doesn't exist
            if (!station.statusHistory) {
                station.statusHistory = [];
            }
            
            // Add current status to history
            station.statusHistory.push({
                timestamp: Date.now(),
                status: isOnline ? 'online' : 'offline'
            });
            
            // Limit history to last 100 entries
            if (station.statusHistory.length > 100) {
                station.statusHistory.shift();
            }
            
            // Calculate uptime percentage
            const totalChecks = station.statusHistory.length;
            const onlineChecks = station.statusHistory.filter(entry => entry.status === 'online').length;
            station.uptime = totalChecks > 0 ? Math.round((onlineChecks / totalChecks) * 100) : 0;
        }

        // Update online/total station counters
        function updateCounters() {
            const total = stations.length;
            const online = stations.filter(s => s.status === 'online').length;
            
            totalStationsCounter.textContent = total;
            onlineStationsCounter.textContent = online;
            
            // Pulse animation if all stations are online
            if (online === total && total > 0) {
                onlineStationsCounter.classList.add('pulse');
            } else {
                onlineStationsCounter.classList.remove('pulse');
            }
        }

        // Update the last update timestamp
        function updateLastUpdateTime() {
            const now = new Date();
            lastUpdateTime.textContent = formatDate(now);
        }

        // Start the automatic update timer
        function startUpdateTimer() {
            // Clear any existing timer
            if (updateTimer) {
                clearInterval(updateTimer);
            }
            
            // Set new timer
            updateTimer = setInterval(() => {
                checkAllStations();
            }, updateInterval);
        }

        // Switch between card and map views
        function switchView(viewName) {
            if (viewName === 'card') {
                cardView.classList.remove('hidden');
                cardView.classList.add('block');
                mapView.classList.add('hidden');
                mapView.classList.remove('block');
                
                cardViewBtn.classList.add('border-blue-600', 'text-blue-600', 'dark:text-blue-400');
                mapViewBtn.classList.remove('border-blue-600', 'text-blue-600', 'dark:text-blue-400');
                
                // Save preference
                setCookie('preferredView', 'card', 30);
            } else {
                cardView.classList.add('hidden');
                cardView.classList.remove('block');
                mapView.classList.remove('hidden');
                mapView.classList.add('block');
                
                cardViewBtn.classList.remove('border-blue-600', 'text-blue-600', 'dark:text-blue-400');
                mapViewBtn.classList.add('border-blue-600', 'text-blue-600', 'dark:text-blue-400');
                
                // Refresh map
                map.invalidateSize();
                
                // Save preference
                setCookie('preferredView', 'map', 30);
            }
        }

        // Open the add station modal
        function openAddStationModal() {
            isEditingStation = false;
            document.getElementById('station-modal-title').textContent = 'Add Station';
            document.getElementById('station-form').reset();
            document.getElementById('station-edit-id').value = '';
            
            // Reset location marker
            if (locationMarker) {
                locationMap.removeLayer(locationMarker);
                locationMarker = null;
            }
            
            // Center map on Maldives
            locationMap.setView([3.2028, 73.2207], 7);
            
            // Force map to recalculate size
            setTimeout(() => {
                locationMap.invalidateSize();
            }, 100);
            
            // Show modal
            document.getElementById('station-modal').classList.remove('hidden');
        }

        // Open the edit station modal
        function openEditStationModal(stationId) {
            const station = stations.find(s => s.id === stationId);
            if (!station) return;
            
            isEditingStation = true;
            editingStationId = stationId;
            
            document.getElementById('station-modal-title').textContent = 'Edit Station';
            document.getElementById('station-edit-id').value = stationId;
            document.getElementById('station-id').value = station.id;
            document.getElementById('station-name').value = station.name || '';
            document.getElementById('gnss-ip').value = station.gnssIP || '';
            document.getElementById('rut-ip').value = station.rutIP || '';
            
            if (station.lat && station.lng) {
                document.getElementById('station-lat').value = station.lat;
                document.getElementById('station-lng').value = station.lng;
                
                // Set marker and center map
                locationMap.setView([station.lat, station.lng], 10);
                
                if (locationMarker) {
                    locationMarker.setLatLng([station.lat, station.lng]);
                } else {
                    locationMarker = L.marker([station.lat, station.lng]).addTo(locationMap);
                }
            } else {
                // Reset marker and center map on Maldives
                if (locationMarker) {
                    locationMap.removeLayer(locationMarker);
                    locationMarker = null;
                }
                locationMap.setView([3.2028, 73.2207], 7);
            }
            
            // Force map to recalculate size
            setTimeout(() => {
                locationMap.invalidateSize();
            }, 100);
            
            // Show modal
            document.getElementById('station-modal').classList.remove('hidden');
        }

        // Save station from modal
        function saveStation() {
            const stationId = document.getElementById('station-id').value.trim();
            const stationName = document.getElementById('station-name').value.trim();
            const gnssIP = document.getElementById('gnss-ip').value.trim();
            const rutIP = document.getElementById('rut-ip').value.trim();
            const lat = parseFloat(document.getElementById('station-lat').value);
            const lng = parseFloat(document.getElementById('station-lng').value);
            
            if (!stationId) {
                showToast('Station ID is required', 'error');
                return;
            }
            
            if (isEditingStation) {
                // Update existing station
                const stationIndex = stations.findIndex(s => s.id === editingStationId);
                if (stationIndex !== -1) {
                    // Keep existing status data
                    const existingStatus = stations[stationIndex].status;
                    const existingLastUpdate = stations[stationIndex].lastUpdate;
                    const existingUptime = stations[stationIndex].uptime;
                    const existingHistory = stations[stationIndex].statusHistory || [];
                    
                    // Update station
                    stations[stationIndex] = {
                        id: stationId,
                        name: stationName || stationId,
                        gnssIP: gnssIP,
                        rutIP: rutIP,
                        lat: isNaN(lat) ? null : lat,
                        lng: isNaN(lng) ? null : lng,
                        status: existingStatus,
                        lastUpdate: existingLastUpdate,
                        uptime: existingUptime,
                        statusHistory: existingHistory
                    };
                    
                    saveStationsToCookies();
                    renderStations();
                    showToast('Station updated successfully');
                }
            } else {
                // Add new station
                const existingStation = stations.find(s => s.id === stationId);
                if (existingStation) {
                    showToast('A station with this ID already exists', 'error');
                    return;
                }
                
                stations.push({
                    id: stationId,
                    name: stationName || stationId,
                    gnssIP: gnssIP,
                    rutIP: rutIP,
                    lat: isNaN(lat) ? null : lat,
                    lng: isNaN(lng) ? null : lng,
                    status: 'unknown',
                    lastUpdate: null,
                    uptime: 0,
                    statusHistory: []
                });
                
                saveStationsToCookies();
                renderStations();
                updateCounters();
                showToast('Station added successfully');
                
                // Check status of the new station
                checkStationStatus(stationId);
            }
            
            // Close modal
            document.getElementById('station-modal').classList.add('hidden');
        }

        // Confirm deletion of a station
        function confirmDeleteStation(stationId) {
            const station = stations.find(s => s.id === stationId);
            if (!station) return;
            
            const message = `Are you sure you want to delete the station "${station.name || station.id}"?`;
            
            if (confirm(message)) {
                deleteStation(stationId);
            }
        }

        // Delete a station
        function deleteStation(stationId) {
            const stationIndex = stations.findIndex(s => s.id === stationId);
            if (stationIndex === -1) return;
            
            // Remove from stations array
            stations.splice(stationIndex, 1);
            
            // Remove marker if it exists
            if (stationMarkers[stationId]) {
                map.removeLayer(stationMarkers[stationId]);
                delete stationMarkers[stationId];
            }
            
            // Update UI
            saveStationsToCookies();
            renderStations();
            updateCounters();
            showToast('Station deleted');
        }

        // Open access modal for GNSS or RUT IP
        function openAccessModal(stationId, type) {
            const station = stations.find(s => s.id === stationId);
            if (!station) return;
            
            const modalTitle = document.getElementById('access-modal-title');
            const stationName = document.getElementById('access-station-name');
            const accessIP = document.getElementById('access-ip');
            const accessLink = document.getElementById('access-link');
            
            if (type === 'gnss') {
                modalTitle.textContent = 'Access GNSS IP';
                stationName.textContent = station.name || station.id;
                accessIP.textContent = station.gnssIP;
                accessLink.href = `http://${station.gnssIP}`;
            } else {
                modalTitle.textContent = 'Access RUT IP';
                stationName.textContent = station.name || station.id;
                accessIP.textContent = station.rutIP;
                accessLink.href = `http://${station.rutIP}`;
            }
            
            // Show modal
            document.getElementById('access-modal').classList.remove('hidden');
        }

        // Load settings from cookies
        function loadSettings() {
            // Load update interval
            const savedInterval = getCookie('updateInterval');
            if (savedInterval) {
                updateInterval = parseInt(savedInterval);
                
                // Update radio buttons in settings
                const intervalRadios = document.querySelectorAll('input[name="update-interval"]');
                intervalRadios.forEach(radio => {
                    if (parseInt(radio.value) === updateInterval) {
                        radio.checked = true;
                    }
                });
            }
            
            // Load theme preference
            const savedTheme = getCookie('theme');
            if (savedTheme) {
                darkMode = savedTheme === 'dark';
                
                // Update radio buttons in settings
                const themeRadios = document.querySelectorAll('input[name="theme"]');
                themeRadios.forEach(radio => {
                    if (radio.value === savedTheme) {
                        radio.checked = true;
                    }
                });
            }
            
            // Load preferred view
            const preferredView = getCookie('preferredView');
            if (preferredView) {
                switchView(preferredView);
            }
        }

        // Save settings to cookies and apply them
        function saveSettings() {
            // Save update interval
            const intervalRadios = document.querySelectorAll('input[name="update-interval"]');
            let newInterval = 30000; // Default
            
            intervalRadios.forEach(radio => {
                if (radio.checked) {
                    newInterval = parseInt(radio.value);
                }
            });
            
            updateInterval = newInterval;
            setCookie('updateInterval', updateInterval.toString(), 30);
            
            // Restart update timer
            startUpdateTimer();
            
            // Save theme
            const themeRadios = document.querySelectorAll('input[name="theme"]');
            let newTheme = 'light';
            
            themeRadios.forEach(radio => {
                if (radio.checked) {
                    newTheme = radio.value;
                }
            });
            
            darkMode = newTheme === 'dark';
            setCookie('theme', newTheme, 30);
            applyTheme();
            
            showToast('Settings saved');
            
            // Close modal
            document.getElementById('settings-modal').classList.add('hidden');
        }

        // Apply the current theme
        function applyTheme() {
            if (darkMode) {
                document.body.classList.add('dark');
            } else {
                document.body.classList.remove('dark');
            }
        }

        // Clear all station data
        function clearAllStationData() {
            if (confirm('Are you sure you want to clear all station data? This cannot be undone.')) {
                stations = [];
                
                // Clear cookies
                document.cookie = 'stations=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                
                // Update UI
                renderStations();
                updateCounters();
                showToast('All station data cleared');
                
                // Close modal
                document.getElementById('settings-modal').classList.add('hidden');
            }
        }

        // Set up all event listeners
        function setupEventListeners() {
            // View tab buttons
            cardViewBtn.addEventListener('click', () => switchView('card'));
            mapViewBtn.addEventListener('click', () => switchView('map'));
            
            // Action buttons
            addStationBtn.addEventListener('click', openAddStationModal);
            settingsBtn.addEventListener('click', () => {
                document.getElementById('settings-modal').classList.remove('hidden');
            });
            checkAllBtn.addEventListener('click', checkAllStations);
            
            // Modal close buttons
            document.querySelectorAll('[data-dismiss]').forEach(element => {
                const modalId = element.getAttribute('data-dismiss');
                element.addEventListener('click', () => {
                    document.getElementById(modalId).classList.add('hidden');
                });
            });
            
            // Save buttons
            document.getElementById('save-station-btn').addEventListener('click', saveStation);
            document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
            document.getElementById('clear-data-btn').addEventListener('click', clearAllStationData);
        }

        // Save stations to cookies
        function saveStationsToCookies() {
            const stationsJSON = JSON.stringify(stations);
            setCookie('stations', stationsJSON, 30);
        }

        // Load stations from cookies
        function getStationsFromCookies() {
            const stationsJSON = getCookie('stations');
            if (stationsJSON) {
                try {
                    return JSON.parse(stationsJSON);
                } catch (error) {
                    console.error('Error parsing stations from cookies:', error);
                    return null;
                }
            }
            return null;
        }

        // Set a cookie
        function setCookie(name, value, days) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            const expires = `expires=${date.toUTCString()}`;
            document.cookie = `${name}=${value};${expires};path=/`;
        }

        // Get a cookie
        function getCookie(name) {
            const cookieName = `${name}=`;
            const decodedCookie = decodeURIComponent(document.cookie);
            const cookieArray = decodedCookie.split(';');
            
            for (let i = 0; i < cookieArray.length; i++) {
                let cookie = cookieArray[i];
                while (cookie.charAt(0) === ' ') {
                    cookie = cookie.substring(1);
                }
                if (cookie.indexOf(cookieName) === 0) {
                    return cookie.substring(cookieName.length, cookie.length);
                }
            }
            return '';
        }

        // Show loading overlay
        function showLoading(message) {
            loadingMessage.textContent = message || 'Loading...';
            loadingOverlay.classList.remove('hidden');
        }

        // Hide loading overlay
        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            // Set message
            toastMessage.textContent = message;
            
            // Set color based on type
            if (type === 'error') {
                toast.classList.add('bg-red-600');
                toast.classList.remove('bg-gray-800', 'bg-green-600');
            } else if (type === 'success') {
                toast.classList.add('bg-green-600');
                toast.classList.remove('bg-gray-800', 'bg-red-600');
            } else {
                toast.classList.add('bg-gray-800');
                toast.classList.remove('bg-red-600', 'bg-green-600');
            }
            
            // Show toast
            toast.classList.remove('hidden');
            toast.classList.remove('opacity-0');
            toast.classList.add('opacity-100');
            
            // Hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
                
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 300);
            }, 3000);
        }

        // Format date for display
        function formatDate(date) {
            if (!date) return 'Never';
            
            if (typeof date === 'string') {
                date = new Date(date);
            }
            
            // If less than a minute ago, show "Just now"
            const secondsAgo = Math.floor((new Date() - date) / 1000);
            if (secondsAgo < 60) {
                return 'Just now';
            }
            
            // If less than an hour ago, show minutes
            if (secondsAgo < 3600) {
                const minutes = Math.floor(secondsAgo / 60);
                return `${minutes} ${minutes === 1 ? 'minute' : 'minutes'} ago`;
            }
            
            // Format date as HH:MM:SS
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const seconds = date.getSeconds().toString().padStart(2, '0');
            
            return `${hours}:${minutes}:${seconds}`;
        }

        // Get color based on status
        function getStatusColor(status) {
            return status === 'online' ? 'green' : 
                   status === 'offline' ? 'red' : 'yellow';
        }

        // Get color based on uptime percentage
        function getUptimeColor(uptime) {
            return uptime >= 90 ? 'green' : 
                   uptime >= 70 ? 'yellow' : 'red';
        }

    </script>
</body>
</html>
