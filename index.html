<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WSCORS Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        :root {
            --primary-color: #3763f4;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-color: #dee2e6;
        }
        
        .status-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-dot.online {
            background-color: var(--success-color);
            box-shadow: 0 0 8px var(--success-color);
        }
        
        .status-dot.offline {
            background-color: var(--danger-color);
            box-shadow: 0 0 8px var(--danger-color);
        }
        
        .status-dot.unknown {
            background-color: var(--warning-color);
            box-shadow: 0 0 8px var(--warning-color);
        }
        
        .uptime-bar {
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 4px;
        }
        
        .uptime-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s;
        }
        
        .uptime-high {
            background-color: var(--success-color);
        }
        
        .uptime-medium {
            background-color: var(--warning-color);
        }
        
        .uptime-low {
            background-color: var(--danger-color);
        }
        
        #map, #location-map {
            height: 500px;
            border-radius: 8px;
        }
        
        #location-map {
            height: 300px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .dark-theme {
            --text-color: #f8f9fa;
            --background-color: #2c3e50;
            --card-background: #34495e;
            --header-background: #1a2533;
            --border-color: #4b6584;
            --modal-background: #34495e;
        }
        
        .dark-theme {
            color: var(--text-color);
            background-color: var(--background-color);
        }
        
        .dark-theme .bg-white {
            background-color: var(--card-background) !important;
        }
        
        .dark-theme .border {
            border-color: var(--border-color) !important;
        }
        
        .dark-theme input, .dark-theme select {
            background-color: var(--card-background);
            color: var(--text-color);
            border-color: var(--border-color);
        }
        
        .dark-theme .text-gray-700 {
            color: var(--text-color) !important;
        }
        
        .dark-theme .spinner {
            border-color: rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary-color);
        }
        
        /* IP button styles */
        .ip-btn {
            padding: 5px 10px;
            border-radius: 4px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 2px;
            font-size: 0.8rem;
            cursor: pointer;
        }
        
        .gnss-ip-btn {
            background-color: #6c5ce7;
            color: white;
        }
        
        .rut-ip-btn {
            background-color: #00b894;
            color: white;
        }
        
        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-80 z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <div id="loading-message" class="text-lg font-semibold">Loading dashboard...</div>
        </div>
    </div>

    <!-- API Data Modal -->
    <div id="api-data-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-lg max-w-4xl w-full max-h-screen">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-bold">Raw API Data</h2>
                <button id="close-api-modal" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
            </div>
            <div class="p-4 overflow-auto max-h-[80vh]">
                <pre id="api-data-content" class="bg-gray-100 p-4 rounded text-sm overflow-auto max-h-[60vh]">Loading API data...</pre>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-lg max-w-md w-full">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-bold">Settings</h2>
                <button class="close-modal text-gray-500 hover:text-gray-700 text-2xl">×</button>
            </div>
            <div class="p-4">
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">Update Interval</label>
                    <div class="flex flex-wrap gap-2">
                        <label class="inline-flex items-center">
                            <input type="radio" name="update-interval" value="10000" class="mr-2">
                            <span>10 seconds</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="update-interval" value="30000" class="mr-2" checked>
                            <span>30 seconds</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="update-interval" value="60000" class="mr-2">
                            <span>1 minute</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="update-interval" value="300000" class="mr-2">
                            <span>5 minutes</span>
                        </label>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">Theme</label>
                    <div class="flex gap-2">
                        <label class="inline-flex items-center">
                            <input type="radio" name="theme" value="light" class="mr-2" checked>
                            <span>Light</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="theme" value="dark" class="mr-2">
                            <span>Dark</span>
                        </label>
                    </div>
                </div>
                <div class="mb-4">
                    <button id="clear-data-btn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition">
                        Clear All Station Data
                    </button>
                </div>
            </div>
            <div class="p-4 border-t text-right">
                <button id="save-settings-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">
                    Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Station Modal -->
    <div id="station-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 id="station-modal-title" class="text-xl font-bold">Add Station</h2>
                <button class="close-modal text-gray-500 hover:text-gray-700 text-2xl">×</button>
            </div>
            <div class="p-4">
                <form id="station-form" class="space-y-4">
                    <input type="hidden" id="station-edit-id">
                    
                    <div>
                        <label for="station-id" class="block text-gray-700 font-semibold mb-2">Station ID</label>
                        <input type="text" id="station-id" class="w-full px-3 py-2 border rounded" required>
                    </div>
                    
                    <div>
                        <label for="station-name" class="block text-gray-700 font-semibold mb-2">Display Name</label>
                        <input type="text" id="station-name" class="w-full px-3 py-2 border rounded" placeholder="Optional">
                    </div>
                    
                    <div>
                        <label for="gnss-ip" class="block text-gray-700 font-semibold mb-2">GNSS IP</label>
                        <input type="text" id="gnss-ip" class="w-full px-3 py-2 border rounded" placeholder="e.g., 10.64.50.20">
                    </div>
                    
                    <div>
                        <label for="rut-ip" class="block text-gray-700 font-semibold mb-2">RUT IP</label>
                        <input type="text" id="rut-ip" class="w-full px-3 py-2 border rounded" placeholder="e.g., 10.64.50.1">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Location</label>
                        <div id="location-map" class="w-full h-64 border rounded"></div>
                        <p class="text-sm text-gray-500 mt-1">Click on the map to set the location or enter coordinates manually</p>
                        
                        <div class="grid grid-cols-2 gap-4 mt-2">
                            <div>
                                <label for="station-lat" class="block text-gray-700 font-semibold mb-2">Latitude</label>
                                <input type="number" id="station-lat" class="w-full px-3 py-2 border rounded" step="0.0001" min="-90" max="90">
                            </div>
                            <div>
                                <label for="station-lng" class="block text-gray-700 font-semibold mb-2">Longitude</label>
                                <input type="number" id="station-lng" class="w-full px-3 py-2 border rounded" step="0.0001" min="-180" max="180">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="p-4 border-t text-right">
                <button id="save-station-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">
                    Save Station
                </button>
            </div>
        </div>
    </div>

    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col sm:flex-row justify-between items-center">
                <div class="flex items-center mb-2 sm:mb-0">
                    <i class="fas fa-satellite-dish text-blue-500 text-2xl mr-3"></i>
                    <h1 class="text-2xl font-bold">NTRIP CORS Station Monitor</h1>
                </div>
                <div class="flex flex-wrap items-center gap-2">
                    <button id="view-api-btn" class="bg-indigo-600 text-white px-3 py-2 rounded-md text-sm font-medium hover:bg-indigo-700 transition flex items-center">
                        <i class="fas fa-code mr-1"></i> View API Data
                    </button>
                    <button id="check-all-btn" class="bg-blue-500 text-white px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-600 transition flex items-center">
                        <i class="fas fa-sync-alt mr-1"></i> Check All
                    </button>
                    <button id="add-station-btn" class="bg-green-500 text-white px-3 py-2 rounded-md text-sm font-medium hover:bg-green-600 transition flex items-center">
                        <i class="fas fa-plus mr-1"></i> Add Station
                    </button>
                    <button id="settings-btn" class="bg-gray-200 text-gray-700 px-3 py-2 rounded-md text-sm font-medium hover:bg-gray-300 transition flex items-center">
                        <i class="fas fa-cog mr-1"></i> Settings
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-4">
        <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
            <div class="flex flex-wrap justify-between items-center">
                <div class="flex gap-4 mb-2 sm:mb-0">
                    <button id="card-view-btn" class="px-3 py-2 rounded-md text-sm font-medium bg-blue-100 text-blue-700 flex items-center">
                        <i class="fas fa-th-large mr-1"></i> Card View
                    </button>
                    <button id="map-view-btn" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100 transition flex items-center">
                        <i class="fas fa-map-marked-alt mr-1"></i> Map View
                    </button>
                </div>
                <div class="flex flex-wrap gap-4">
                    <div class="flex items-center">
                        <div class="text-sm font-medium bg-blue-100 text-blue-800 px-3 py-1 rounded-full flex items-center">
                            <i class="fas fa-broadcast-tower mr-1"></i>
                            <span id="station-count">0</span> Stations
                        </div>
                    </div>
                    <div class="flex items-center">
                        <div class="text-sm font-medium bg-green-100 text-green-800 px-3 py-1 rounded-full flex items-center">
                            <i class="fas fa-check-circle mr-1"></i>
                            <span id="online-count">0</span> Online
                        </div>
                    </div>
                    <div class="text-sm text-gray-500">
                        Last update: <span id="last-update-time">Never</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="card-view" class="view-container">
            <div id="station-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                <div id="station-loading" class="col-span-full text-center py-8">
                    <div class="spinner mx-auto mb-4"></div>
                    <p class="text-gray-700">Loading stations...</p>
                </div>
            </div>
        </div>
        
        <div id="map-view" class="view-container hidden">
            <div id="map" class="w-full h-[600px] rounded-lg shadow"></div>
        </div>
    </div>

    <script>
        // Constants and configuration
        const API_URL = 'https://asia-southeast1-cors-428306.cloudfunctions.net/getNtripData';
        
        // Define the fixed order for stations
        const stationOrder = ['KDM', 'MAD', 'MLE', 'SUN', 'FOH', 'HMLE', 'OORR', 'EYD'];
        
        // Default station data with IPs
        const defaultStations = [
            { id: 'KDM', name: 'Kaadedhdhoo', gnssIp: '10.64.80.167', rutIp: '10.64.80.0', lat: 0.4889, lng: 73.0000 },
            { id: 'MAD', name: 'Maadhoo', gnssIp: '10.64.60.167', rutIp: '10.64.60.1', lat: 3.4711, lng: 72.8369 },
            { id: 'MLE', name: 'Male', gnssIp: '10.64.50.20', rutIp: '10.64.50.1', lat: 4.1754, lng: 73.5093 },
            { id: 'SUN', name: 'Sun Island', gnssIp: '10.64.10.167', rutIp: '10.64.10.1', lat: 3.4825, lng: 72.8555 },
            { id: 'FOH', name: 'Fohtheyo', gnssIp: '10.64.70.167', rutIp: '10.64.70.1', lat: 4.3000, lng: 73.7000 },
            { id: 'HMLE', name: 'Hulhumale', gnssIp: '172.17.10.167', rutIp: '172.17.10.1', lat: 4.2133, lng: 73.5566 },
            { id: 'OORR', name: 'One $ Only Reethi Rah', gnssIp: '110.64.40.167', rutIp: '110.64.40.1', lat: -0.6287, lng: 73.1044 },
            { id: 'EYD', name: 'Eydhafushi', gnssIp: '10.64.90.167', rutIp: '10.64.90.1', lat: 5.1033, lng: 73.0707 }
        ];
        
        let stations = [];
        let map = null;
        let locationMap = null;
        let locationMarker = null;
        let isSelectingLocation = false;
        let stationMarkers = {};
        let updateInterval = 30000; // 30 seconds default
        let updateTimer = null;
        let isEditingStation = false;
        let editingStationId = null;
        let lastApiData = null;

        // DOM Elements
        const cardViewBtn = document.getElementById('card-view-btn');
        const mapViewBtn = document.getElementById('map-view-btn');
        const cardView = document.getElementById('card-view');
        const mapView = document.getElementById('map-view');
        const stationCards = document.getElementById('station-cards');
        const addStationBtn = document.getElementById('add-station-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const checkAllBtn = document.getElementById('check-all-btn');
        const viewApiBtn = document.getElementById('view-api-btn');
        const lastUpdateTime = document.getElementById('last-update-time');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingMessage = document.getElementById('loading-message');
        const stationCount = document.getElementById('station-count');
        const onlineCount = document.getElementById('online-count');

        // Modal Elements
        const settingsModal = document.getElementById('settings-modal');
        const stationModal = document.getElementById('station-modal');
        const apiDataModal = document.getElementById('api-data-modal');
        const closeApiModal = document.getElementById('close-api-modal');
        const apiDataContent = document.getElementById('api-data-content');
        const stationModalTitle = document.getElementById('station-modal-title');
        const stationForm = document.getElementById('station-form');
        const stationIdInput = document.getElementById('station-id');
        const stationNameInput = document.getElementById('station-name');
        const gnssIpInput = document.getElementById('gnss-ip');
        const rutIpInput = document.getElementById('rut-ip');
        const stationLatInput = document.getElementById('station-lat');
        const stationLngInput = document.getElementById('station-lng');
        const stationEditIdInput = document.getElementById('station-edit-id');
        const saveStationBtn = document.getElementById('save-station-btn');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const clearDataBtn = document.getElementById('clear-data-btn');

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', () => {
            initializeDashboard();
        });

        // Dashboard initialization
        async function initializeDashboard() {
            showLoading('Initializing dashboard...');
            
            // Load settings from cookies
            loadSettings();
            
            // Apply theme
            applyTheme();
            
            // Initialize map
            initializeMap();
            initializeLocationMap();
            
            // Load stations (from cookies first, then from API)
            await loadStations();
            
            // Start update timer
            startUpdateTimer();
            
            // Initialize event listeners
            initializeEventListeners();
            
            // Hide loading overlay
            hideLoading();
        }

        // Initialize the main map
        function initializeMap() {
            map = L.map('map').setView([3.2028, 73.2207], 7); // Maldives center
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }

        // Initialize the location selection map
        function initializeLocationMap() {
            locationMap = L.map('location-map').setView([3.2028, 73.2207], 7);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(locationMap);
            
            // Add click event for location selection
            locationMap.on('click', function(e) {
                if (isSelectingLocation) {
                    const lat = e.latlng.lat.toFixed(4);
                    const lng = e.latlng.lng.toFixed(4);
                    
                    // Update form fields
                    stationLatInput.value = lat;
                    stationLngInput.value = lng;
                    
                    // Update marker position
                    if (locationMarker) {
                        locationMarker.setLatLng(e.latlng);
                    } else {
                        locationMarker = L.marker(e.latlng).addTo(locationMap);
                    }
                }
            });
        }

        // Initialize event listeners
        function initializeEventListeners() {
            // View tab buttons
            cardViewBtn.addEventListener('click', () => switchView('card'));
            mapViewBtn.addEventListener('click', () => switchView('map'));
            
            // Modal buttons
            addStationBtn.addEventListener('click', showAddStationModal);
            settingsBtn.addEventListener('click', showSettingsModal);
            checkAllBtn.addEventListener('click', checkAllStations);
            viewApiBtn.addEventListener('click', showApiDataModal);
            
            // Close API modal
            closeApiModal.addEventListener('click', () => {
                apiDataModal.classList.add('hidden');
            });
            
            // Close modal buttons
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const modal = e.target.closest('.fixed');
                    if (modal) {
                        modal.classList.add('hidden');
                    }
                });
            });
            
            // Save station button
            saveStationBtn.addEventListener('click', saveStation);
            
            // Save settings button
            saveSettingsBtn.addEventListener('click', saveSettings);
            
            // Clear data button
            clearDataBtn.addEventListener('click', clearAllData);
        }

        // Switch between card and map views
        function switchView(viewType) {
            if (viewType === 'card') {
                cardView.classList.remove('hidden');
                mapView.classList.add('hidden');
                cardViewBtn.classList.add('bg-blue-100', 'text-blue-700');
                cardViewBtn.classList.remove('text-gray-700', 'hover:bg-gray-100');
                mapViewBtn.classList.remove('bg-blue-100', 'text-blue-700');
                mapViewBtn.classList.add('text-gray-700', 'hover:bg-gray-100');
            } else {
                cardView.classList.add('hidden');
                mapView.classList.remove('hidden');
                cardViewBtn.classList.remove('bg-blue-100', 'text-blue-700');
                cardViewBtn.classList.add('text-gray-700', 'hover:bg-gray-100');
                mapViewBtn.classList.add('bg-blue-100', 'text-blue-700');
                mapViewBtn.classList.remove('text-gray-700', 'hover:bg-gray-100');
                
                // Refresh map when switching to map view
                if (map) {
                    map.invalidateSize();
                    updateMapMarkers();
                }
            }
        }

        // Load stations from cookies and API
        async function loadStations() {
            // Try to load from cookies first
            const savedStations = getStationsFromCookies();
            
            if (savedStations && savedStations.length > 0) {
                stations = savedStations;
                renderStations();
            } else {
                // Use default stations with IPs
                stations = defaultStations.map(station => ({
                    ...station,
                    status: 'unknown',
                    lastUpdate: null,
                    uptime: 0,
                    statusHistory: []
                }));
                saveStationsToCookies(stations);
            }
            
            // Render the stations
            renderStations();
            
            // Then fetch from API and update status
            try {
                const apiStations = await fetchStationsFromAPI();
                updateStationsFromAPI(apiStations);
            } catch (error) {
                console.error('Error loading stations from API:', error);
            }
            
            // Check status of all stations
            await checkAllStations();
        }

        // Fetch stations from the API
        async function fetchStationsFromAPI() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`Failed to fetch stations: ${response.status}`);
                }
                
                const apiData = await response.json();
                lastApiData = apiData; // Store the raw API data
                return apiData;
            } catch (error) {
                console.error('Error fetching stations from API:', error);
                return [];
            }
        }

        // Update stations from API data
        function updateStationsFromAPI(apiStations) {
            // For each API station, update or add to our stations array
            apiStations.forEach(apiStation => {
                const stationId = apiStation.name;
                
                // Check if station already exists
                let existingStation = stations.find(s => s.id === stationId);
                
                if (!existingStation) {
                    // If it doesn't exist, add it
                    const newStation = {
                        id: stationId,
                        name: formatStationName(stationId),
                        status: 'unknown',
                        lastUpdate: null,
                        uptime: 0,
                        statusHistory: [],
                        lat: getDefaultLatitude(stationId),
                        lng: getDefaultLongitude(stationId)
                    };
                    
                    // Check if we have default IP information for this station
                    const defaultStation = defaultStations.find(s => s.id === stationId);
                    if (defaultStation) {
                        newStation.gnssIp = defaultStation.gnssIp;
                        newStation.rutIp = defaultStation.rutIp;
                    }
                    
                    stations.push(newStation);
                }
            });
            
            // Save updated stations to cookies
            saveStationsToCookies(stations);
            
            // Re-render stations
            renderStations();
        }

        // Format station name
        function formatStationName(stationId) {
            // Check if we have a default name
            const defaultStation = defaultStations.find(s => s.id === stationId);
            if (defaultStation && defaultStation.name) {
                return defaultStation.name;
            }
            
            // Otherwise format the ID
            return stationId.charAt(0).toUpperCase() + stationId.slice(1).toLowerCase();
        }

        // Get default latitude for a station
        function getDefaultLatitude(stationId) {
            const defaultStation = defaultStations.find(s => s.id === stationId);
            if (defaultStation && defaultStation.lat) {
                return defaultStation.lat;
            }
            return 3.2028; // Default to Maldives center
        }

        // Get default longitude for a station
        function getDefaultLongitude(stationId) {
            const defaultStation = defaultStations.find(s => s.id === stationId);
            if (defaultStation && defaultStation.lng) {
                return defaultStation.lng;
            }
            return 73.2207; // Default to Maldives center
        }

        // Render stations in the ordered list
        function renderStations() {
            // Clear current station cards
            stationCards.innerHTML = '';
            
            // Clear current map markers
            clearMapMarkers();
            
            // Sort stations based on predefined order
            const sortedStations = [...stations].sort((a, b) => {
                const indexA = stationOrder.indexOf(a.id);
                const indexB = stationOrder.indexOf(b.id);
                
                // If both stations are in the order list, sort by their position
                if (indexA !== -1 && indexB !== -1) {
                    return indexA - indexB;
                }
                
                // If only one station is in the order list, prioritize it
                if (indexA !== -1) return -1;
                if (indexB !== -1) return 1;
                
                // If neither is in the order list, sort alphabetically
                return a.id.localeCompare(b.id);
            });
            
            // Update station counters
            stationCount.textContent = sortedStations.length;
            onlineCount.textContent = sortedStations.filter(s => s.status === 'online').length;
            
            // Render each station
            sortedStations.forEach(station => {
                // Create card for the station
                const card = createStationCard(station);
                stationCards.appendChild(card);
                
                // Add marker to the map if coordinates are available
                if (station.lat && station.lng) {
                    addStationMarker(station);
                }
            });
            
            // Add "Add Station" card at the end
            const addCard = document.createElement('div');
            addCard.className = 'bg-white rounded-lg shadow-sm border border-dashed border-gray-300 p-4 flex flex-col items-center justify-center h-64 cursor-pointer hover:border-blue-500 hover:shadow transition-all';
            addCard.innerHTML = `
                <div class="w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center mb-4">
                    <i class="fas fa-plus text-blue-500 text-xl"></i>
                </div>
                <h3 class="text-lg font-semibold mb-2">Add Station</h3>
                <p class="text-gray-500 text-center">Click to add a new CORS station</p>
            `;
            addCard.addEventListener('click', showAddStationModal);
            stationCards.appendChild(addCard);
        }

        // Create station card
        function createStationCard(station) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-sm overflow-hidden';
            card.id = `station-card-${station.id}`;
            
            // Status label
            let statusLabel = 'Unknown';
            let statusColor = 'text-yellow-600';
            
            if (station.status === 'online') {
                statusLabel = 'Online';
                statusColor = 'text-green-600';
            } else if (station.status === 'offline') {
                statusLabel = 'Offline';
                statusColor = 'text-red-600';
            }
            
            // Uptime class
            let uptimeClass = 'uptime-low';
            if (station.uptime >= 90) {
                uptimeClass = 'uptime-high';
            } else if (station.uptime >= 70) {
                uptimeClass = 'uptime-medium';
            }
            
            // Last update time
            let lastUpdateText = 'Never';
            if (station.lastUpdate) {
                const lastUpdate = new Date(station.lastUpdate);
                lastUpdateText = lastUpdate.toLocaleTimeString();
            }
            
            card.innerHTML = `
                <div class="p-4 border-b">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-semibold">${station.name || station.id}</h3>
                            <div class="text-sm text-gray-500">${station.id}</div>
                        </div>
                        <div class="flex space-x-2">
                            <button class="edit-station-btn text-blue-500 hover:text-blue-700" data-station-id="${station.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-station-btn text-red-500 hover:text-red-700" data-station-id="${station.id}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="p-4">
                    <div class="flex items-center mb-3">
                        <div class="status-dot ${station.status}"></div>
                        <div class="font-semibold ${statusColor}">${statusLabel}</div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <div>
                            <div class="text-sm text-gray-500 mb-1">Uptime</div>
                            <div class="font-medium">${station.uptime}%</div>
                            <div class="uptime-bar">
                                <div class="uptime-bar-fill ${uptimeClass}" style="width: ${station.uptime}%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500 mb-1">Last Check</div>
                            <div class="font-medium">${lastUpdateText}</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="text-sm text-gray-500 mb-1">IP Addresses</div>
                        <div class="flex flex-wrap gap-1 mb-2">
                            ${station.gnssIp ? `
                                <a href="http://${station.gnssIp}" target="_blank" class="ip-btn gnss-ip-btn tooltip">
                                    <i class="fas fa-satellite-dish mr-1"></i> GNSS
                                    <span class="tooltiptext">Connect to GNSS: ${station.gnssIp}</span>
                                </a>
                            ` : ''}
                            ${station.rutIp ? `
                                <a href="http://${station.rutIp}" target="_blank" class="ip-btn rut-ip-btn tooltip">
                                    <i class="fas fa-network-wired mr-1"></i> RUT
                                    <span class="tooltiptext">Connect to RUT: ${station.rutIp}</span>
                                </a>
                            ` : ''}
                        </div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500 mb-1">Coordinates</div>
                        <div class="font-medium">
                            ${station.lat ? station.lat.toFixed(4) : 'N/A'}, 
                            ${station.lng ? station.lng.toFixed(4) : 'N/A'}
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 p-2 border-t">
                    <button class="check-station-btn w-full text-blue-500 hover:bg-gray-100 py-2 rounded text-sm font-medium" data-station-id="${station.id}">
                        <i class="fas fa-sync-alt mr-1"></i> Check Status
                    </button>
                </div>
            `;
            
            // Add event listeners
            setTimeout(() => {
                const editBtn = card.querySelector('.edit-station-btn');
                const deleteBtn = card.querySelector('.delete-station-btn');
                const checkBtn = card.querySelector('.check-station-btn');
                
                if (editBtn) {
                    editBtn.addEventListener('click', () => showEditStationModal(station.id));
                }
                
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', () => confirmDeleteStation(station.id));
                }
                
                if (checkBtn) {
                    checkBtn.addEventListener('click', () => checkStationStatus(station.id));
                }
            }, 0);
            
            return card;
        }

        // Add a marker to the map for a station
        function addStationMarker(station) {
            if (!map || !station.lat || !station.lng) return;
            
            // Determine marker color based on status
            let markerColor = '#ffc107'; // yellow for unknown
            if (station.status === 'online') {
                markerColor = '#28a745'; // green
            } else if (station.status === 'offline') {
                markerColor = '#dc3545'; // red
            }
            
            const markerIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="background-color: ${markerColor}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;"></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            // Create or update marker
            if (stationMarkers[station.id]) {
                stationMarkers[station.id].setLatLng([station.lat, station.lng]);
                stationMarkers[station.id].setIcon(markerIcon);
            } else {
                const marker = L.marker([station.lat, station.lng], { icon: markerIcon }).addTo(map);
                
                // Add popup with station info
                marker.bindPopup(`
                    <div class="font-bold">${station.name || station.id}</div>
                    <div class="text-sm">ID: ${station.id}</div>
                    <div class="text-sm">Status: ${station.status}</div>
                    <div class="text-sm">Uptime: ${station.uptime}%</div>
                    <div class="text-sm">Coordinates: ${station.lat.toFixed(4)}, ${station.lng.toFixed(4)}</div>
                `);
                
                stationMarkers[station.id] = marker;
            }
        }

        // Clear all markers from the map
        function clearMapMarkers() {
            if (!map) return;
            
            Object.values(stationMarkers).forEach(marker => {
                marker.remove();
            });
            
            stationMarkers = {};
        }

        // Update map markers based on current station status
        function updateMapMarkers() {
            if (!map) return;
            
            // Clear existing markers
            clearMapMarkers();
            
            // Add updated markers
            stations.forEach(station => {
                if (station.lat && station.lng) {
                    addStationMarker(station);
                }
            });
        }

        // Show add station modal
        function showAddStationModal() {
            // Clear form
            stationForm.reset();
            stationEditIdInput.value = '';
            stationModalTitle.textContent = 'Add Station';
            
            // Clear location marker
            if (locationMarker) {
                locationMarker.remove();
                locationMarker = null;
            }
            
            // Reset the map view
            locationMap.setView([3.2028, 73.2207], 7);
            
            // Enable location selection
            isSelectingLocation = true;
            isEditingStation = false;
            
            // Show modal
            stationModal.classList.remove('hidden');
            
            // Refresh map
            setTimeout(() => {
                locationMap.invalidateSize();
            }, 100);
        }

        // Show edit station modal
        function showEditStationModal(stationId) {
            const station = stations.find(s => s.id === stationId);
            if (!station) return;
            
            // Set form values
            stationIdInput.value = station.id;
            stationNameInput.value = station.name || '';
            gnssIpInput.value = station.gnssIp || '';
            rutIpInput.value = station.rutIp || '';
            stationLatInput.value = station.lat || '';
            stationLngInput.value = station.lng || '';
            stationEditIdInput.value = station.id;
            
            // Update modal title
            stationModalTitle.textContent = 'Edit Station';
            
            // Set marker on the map if coordinates are available
            if (station.lat && station.lng) {
                locationMap.setView([station.lat, station.lng], 10);
                
                if (locationMarker) {
                    locationMarker.setLatLng([station.lat, station.lng]);
                } else {
                    locationMarker = L.marker([station.lat, station.lng]).addTo(locationMap);
                }
            } else {
                // Reset the map view
                locationMap.setView([3.2028, 73.2207], 7);
                
                if (locationMarker) {
                    locationMarker.remove();
                    locationMarker = null;
                }
            }
            
            // Enable location selection
            isSelectingLocation = true;
            isEditingStation = true;
            editingStationId = station.id;
            
            // Show modal
            stationModal.classList.remove('hidden');
            
            // Refresh map
            setTimeout(() => {
                locationMap.invalidateSize();
            }, 100);
        }

        // Show settings modal
        function showSettingsModal() {
            // Set current values
            document.querySelector(`input[name="update-interval"][value="${updateInterval}"]`).checked = true;
            
            const theme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
            document.querySelector(`input[name="theme"][value="${theme}"]`).checked = true;
            
            // Show modal
            settingsModal.classList.remove('hidden');
        }

        // Show API data modal
        async function showApiDataModal() {
            apiDataModal.classList.remove('hidden');
            
            // If we already have API data, show it
            if (lastApiData) {
                apiDataContent.textContent = JSON.stringify(lastApiData, null, 2);
                return;
            }
            
            // Otherwise fetch it
            apiDataContent.textContent = 'Loading API data...';
            
            try {
                const data = await fetchStationsFromAPI();
                apiDataContent.textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                apiDataContent.textContent = `Error fetching API data: ${error.message}`;
            }
        }

        // Save station
        function saveStation() {
            const stationId = stationIdInput.value.trim();
            if (!stationId) {
                alert('Station ID is required');
                return;
            }
            
            const stationName = stationNameInput.value.trim();
            const gnssIp = gnssIpInput.value.trim();
            const rutIp = rutIpInput.value.trim();
            const lat = parseFloat(stationLatInput.value) || null;
            const lng = parseFloat(stationLngInput.value) || null;
            const editId = stationEditIdInput.value;
            
            if (isEditingStation) {
                // Update existing station
                const stationIndex = stations.findIndex(s => s.id === editId);
                if (stationIndex !== -1) {
                    // Preserve status history and last update
                    const statusHistory = stations[stationIndex].statusHistory || [];
                    const lastUpdate = stations[stationIndex].lastUpdate;
                    const status = stations[stationIndex].status;
                    const uptime = stations[stationIndex].uptime;
                    
                    stations[stationIndex] = {
                        id: stationId,
                        name: stationName,
                        gnssIp: gnssIp,
                        rutIp: rutIp,
                        lat: lat,
                        lng: lng,
                        statusHistory: statusHistory,
                        lastUpdate: lastUpdate,
                        status: status,
                        uptime: uptime
                    };
                }
            } else {
                // Add new station
                const newStation = {
                    id: stationId,
                    name: stationName,
                    gnssIp: gnssIp,
                    rutIp: rutIp,
                    lat: lat,
                    lng: lng,
                    status: 'unknown',
                    lastUpdate: null,
                    uptime: 0,
                    statusHistory: []
                };
                
                stations.push(newStation);
            }
            
            // Save to cookies
            saveStationsToCookies(stations);
            
            // Re-render stations
            renderStations();
            
            // Hide modal
            stationModal.classList.add('hidden');
            
            // Check status of the new/updated station
            checkStationStatus(stationId);
        }

        // Save settings
        function saveSettings() {
            // Get selected update interval
            const intervalRadio = document.querySelector('input[name="update-interval"]:checked');
            if (intervalRadio) {
                updateInterval = parseInt(intervalRadio.value);
                
                // Restart update timer with new interval
                startUpdateTimer();
            }
            
            // Get selected theme
            const themeRadio = document.querySelector('input[name="theme"]:checked');
            if (themeRadio) {
                const theme = themeRadio.value;
                
                // Apply theme
                if (theme === 'dark') {
                    document.body.classList.add('dark-theme');
                } else {
                    document.body.classList.remove('dark-theme');
                }
                
                // Save theme to cookies
                document.cookie = `theme=${theme}; path=/; max-age=31536000`; // 1 year
            }
            
            // Save update interval to cookies
            document.cookie = `updateInterval=${updateInterval}; path=/; max-age=31536000`; // 1 year
            
            // Hide modal
            settingsModal.classList.add('hidden');
        }

        // Start update timer
        function startUpdateTimer() {
            // Clear existing timer
            if (updateTimer) {
                clearInterval(updateTimer);
            }
            
            // Start new timer
            updateTimer = setInterval(checkAllStations, updateInterval);
        }

        // Check status of all stations
        async function checkAllStations() {
            if (stations.length === 0) return;
            
            showLoading('Checking station status...');
            
            // Update before status checking
            updateStationCount();
            
            // Check each station
            for (const station of stations) {
                await checkStationStatus(station.id);
            }
            
            // Update last check time
            lastUpdateTime.textContent = new Date().toLocaleTimeString();
            
            // Update after status checking
            updateStationCount();
            
            hideLoading();
        }

        // Check status of a specific station
        async function checkStationStatus(stationId) {
            const station = stations.find(s => s.id === stationId);
            if (!station) return;
            
            try {
                // In a real implementation, this would check the actual status
                // For demo purposes, we're using simulated status based on API data
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`Failed to fetch data: ${response.status}`);
                }
                
                const apiData = await response.json();
                lastApiData = apiData; // Update the raw API data
                
                // Check if station exists in API data
                const stationExists = apiData.some(s => s.name === station.id);
                
                // Simulate 80% chance of being online if the station exists in API
                const isOnline = stationExists && Math.random() < 0.8;
                
                // Update station status
                station.status = isOnline ? 'online' : 'offline';
                station.lastUpdate = Date.now();
                
                // Update uptime
                updateStationUptime(station, isOnline);
                
                // Update UI
                updateStationCard(station);
                updateMapMarkers();
                updateStationCount();
                
                return isOnline;
            } catch (error) {
                console.error(`Error checking status for ${station.id}:`, error);
                
                // Mark as offline on error
                station.status = 'offline';
                station.lastUpdate = Date.now();
                
                // Update uptime
                updateStationUptime(station, false);
                
                // Update UI
                updateStationCard(station);
                updateMapMarkers();
                updateStationCount();
                
                return false;
            }
        }

        // Update station uptime
        function updateStationUptime(station, isOnline) {
            // Initialize history if it doesn't exist
            if (!station.statusHistory) {
                station.statusHistory = [];
            }
            
            // Add current status to history
            station.statusHistory.push({
                timestamp: Date.now(),
                status: isOnline ? 'online' : 'offline'
            });
            
            // Limit history size (keep last 100 entries)
            if (station.statusHistory.length > 100) {
                station.statusHistory.shift();
            }
            
            // Calculate uptime percentage
            const totalChecks = station.statusHistory.length;
            const successfulChecks = station.statusHistory.filter(entry => entry.status === 'online').length;
            station.uptime = totalChecks > 0 ? Math.round((successfulChecks / totalChecks) * 100) : 0;
            
            // Save to cookies
            saveStationsToCookies(stations);
            
            return station.uptime;
        }

        // Update station card in the UI
        function updateStationCard(station) {
            const card = document.getElementById(`station-card-${station.id}`);
            if (!card) return;
            
            // Status label and color
            let statusLabel = 'Unknown';
            let statusColor = 'text-yellow-600';
            
            if (station.status === 'online') {
                statusLabel = 'Online';
                statusColor = 'text-green-600';
            } else if (station.status === 'offline') {
                statusLabel = 'Offline';
                statusColor = 'text-red-600';
            }
            
            // Uptime class
            let uptimeClass = 'uptime-low';
            if (station.uptime >= 90) {
                uptimeClass = 'uptime-high';
            } else if (station.uptime >= 70) {
                uptimeClass = 'uptime-medium';
            }
            
            // Last update time
            let lastUpdateText = 'Never';
            if (station.lastUpdate) {
                const lastUpdate = new Date(station.lastUpdate);
                lastUpdateText = lastUpdate.toLocaleTimeString();
            }
            
            // Update status dot
            const statusDot = card.querySelector('.status-dot');
            if (statusDot) {
                statusDot.className = `status-dot ${station.status}`;
            }
            
            // Update status label
            const statusLabelEl = card.querySelector('.status-dot + div');
            if (statusLabelEl) {
                statusLabelEl.className = `font-semibold ${statusColor}`;
                statusLabelEl.textContent = statusLabel;
            }
            
            // Update uptime
            const uptimeEl = card.querySelector('.uptime-bar-fill');
            if (uptimeEl) {
                uptimeEl.className = `uptime-bar-fill ${uptimeClass}`;
                uptimeEl.style.width = `${station.uptime}%`;
            }
            
            const uptimeTextEl = card.querySelector('.uptime-bar').previousElementSibling;
            if (uptimeTextEl) {
                uptimeTextEl.textContent = `${station.uptime}%`;
            }
            
            // Update last check time
            const lastCheckEl = card.querySelector('.text-sm.text-gray-500.mb-1 + .font-medium');
            if (lastCheckEl) {
                lastCheckEl.textContent = lastUpdateText;
            }
        }

        // Update station counter
        function updateStationCount() {
            stationCount.textContent = stations.length;
            onlineCount.textContent = stations.filter(s => s.status === 'online').length;
        }

        // Confirm delete station
        function confirmDeleteStation(stationId) {
            if (confirm(`Are you sure you want to delete station "${stationId}"?`)) {
                deleteStation(stationId);
            }
        }

        // Delete station
        function deleteStation(stationId) {
            stations = stations.filter(s => s.id !== stationId);
            
            // Save to cookies
            saveStationsToCookies(stations);
            
            // Re-render stations
            renderStations();
        }

        // Clear all data
        function clearAllData() {
            if (confirm('Are you sure you want to clear all station data? This cannot be undone.')) {
                // Clear stations
                stations = [];
                
                // Clear cookies
                document.cookie = 'stations=; path=/; max-age=0';
                
                // Re-render stations
                renderStations();
                
                // Hide modal
                settingsModal.classList.add('hidden');
            }
        }

        // Save stations to cookies
        function saveStationsToCookies(stations) {
            try {
                const stationsJson = JSON.stringify(stations);
                
                // Due to cookie size limitations, we may need to split the data
                // For simplicity, we're assuming the data fits in a single cookie
                // In a production app, consider using localStorage or IndexedDB
                
                document.cookie = `stations=${encodeURIComponent(stationsJson)}; path=/; max-age=31536000`; // 1 year
            } catch (error) {
                console.error('Error saving stations to cookies:', error);
            }
        }

        // Get stations from cookies
        function getStationsFromCookies() {
            try {
                const cookieValue = document.cookie
                    .split('; ')
                    .find(row => row.startsWith('stations='));
                
                if (cookieValue) {
                    const stationsJson = decodeURIComponent(cookieValue.split('=')[1]);
                    return JSON.parse(stationsJson);
                }
                
                return null;
            } catch (error) {
                console.error('Error loading stations from cookies:', error);
                return null;
            }
        }

        // Load settings from cookies
        function loadSettings() {
            // Load update interval
            const intervalCookie = document.cookie
                .split('; ')
                .find(row => row.startsWith('updateInterval='));
            
            if (intervalCookie) {
                const interval = parseInt(intervalCookie.split('=')[1]);
                if (!isNaN(interval)) {
                    updateInterval = interval;
                }
            }
            
            // Load theme
            const themeCookie = document.cookie
                .split('; ')
                .find(row => row.startsWith('theme='));
            
            if (themeCookie) {
                const theme = themeCookie.split('=')[1];
                if (theme === 'dark') {
                    document.body.classList.add('dark-theme');
                }
            }
        }

        // Apply theme
        function applyTheme() {
            // Check if dark theme is enabled
            const isDarkTheme = document.body.classList.contains('dark-theme');
            
            // Apply appropriate class to body
            if (isDarkTheme) {
                document.body.classList.add('dark-theme');
            } else {
                document.body.classList.remove('dark-theme');
            }
        }

        // Show loading overlay
        function showLoading(message) {
            loadingMessage.textContent = message || 'Loading...';
            loadingOverlay.classList.remove('hidden');
        }

        // Hide loading overlay
        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }
    </script>
</body>
</html>
